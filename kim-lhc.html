<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>فرم ارزیابی KIM-LHC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">
  <style>
    body{font-family:Vazirmatn,Tahoma,sans-serif;direction:rtl;text-align:right;max-width:1200px;margin:24px auto;color:#212529;background:#f8f9fa;padding:0 16px;line-height:1.6}
    h2{text-align:center;color:#007bff;margin:0 0 24px}
    h3{margin:0 0 16px;border-bottom:2px solid #007bff;padding-bottom:8px}
    .card{border:1px solid #e9ecef;border-radius:10px;padding:16px;margin:0 0 24px;background:#fff;box-shadow:0 4px 10px rgba(0,0,0,.08)}
    .row{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:16px}
    .date-row{display:flex;gap:8px}
    .date-row select{flex:1;padding:8px}
    label{font-weight:600;display:block;margin-bottom:4px}
    input,select{width:100%;padding:10px;border:1px solid #ced4da;border-radius:6px;font-family:inherit}
    .score-box{font-weight:700;font-size:1.05rem;margin-top:12px;padding:12px;background:#e9f5ff;border:2px solid #cce5ff;border-radius:8px;text-align:center;color:#007bff}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #d7dee3;padding:8px;text-align:center;vertical-align:middle}
    th{background:#eef3f7}
    .selectable{cursor:pointer;transition:background .2s;user-select:none}
    .selectable:hover{background:#f0f8ff}
    .selected{background:#e9f5ff!important;font-weight:700;box-shadow:inset 0 0 0 2px #007bff}
    td img{display:block;margin:auto;object-fit:contain}
    .note{font-size:.92rem;color:#495057;margin-top:6px}
    .tooltip{position:relative;display:inline-block;border-bottom:1px dotted #6c757d;cursor:help}
    .tooltip .tip{visibility:hidden;position:absolute;right:0;bottom:125%;background:#343a40;color:#fff;text-align:right;border-radius:6px;padding:8px;min-width:280px;z-index:2}
    .tooltip:hover .tip{visibility:visible}
    .risk-legend td{font-weight:600}
    .risk1{background:#d4edda}
    .risk2{background:#fff3cd}
    .risk3{background:#ffe0b3}
    .risk4{background:#f8d7da}
    .stack{display:flex;gap:16px;align-items:flex-start}
    .grow{flex:1}
    .imgCell{min-width:260px}
    .imgBox{width:100%;aspect-ratio:5/1;background:#f1f3f5;border:1px dashed #adb5bd;border-radius:6px;display:flex;align-items:center;justify-content:center;color:#6c757d}
    
    /* استایل‌های جدید برای بهینه‌سازی */
    #postureBase td img {max-height: 120px; height: 120px;}
    .posture-container {display: flex; flex-direction: column; gap: 16px;}
    .posture-table-compact {font-size: 0.9rem;}
    .posture-table-compact th, .posture-table-compact td {padding: 6px;}
    .gender-selection {display: flex; gap: 16px; margin-bottom: 16px;}
    .gender-option {flex: 1; text-align: center; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; cursor: pointer;}
    .gender-option.selected {border-color: #007bff; background: #e9f5ff;}
    .compact-summary {display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;}
    .summary-card {border: 1px solid #e9ecef; border-radius: 8px; padding: 16px; background: #f8f9fa;}
    .summary-value {font-size: 1.2rem; font-weight: bold; text-align: center; margin: 8px 0;}
    .risk-highlight {border: 3px solid !important; font-weight: bold;}
    .risk1-highlight {border-color: #28a745 !important; background-color: #d4edda !important;}
    .risk2-highlight {border-color: #ffc107 !important; background-color: #fff3cd !important;}
    .risk3-highlight {border-color: #fd7e14 !important; background-color: #ffe0b3 !important;}
    .risk4-highlight {border-color: #dc3545 !important; background-color: #f8d7da !important;}
    .action-buttons {display: flex; justify-content: space-between; margin: 24px 0;}
    .btn {padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-family: Vazirmatn, Tahoma, sans-serif; font-weight: 600;}
    .btn-reset {background: #dc3545; color: white;}
    .btn-print {background: #007bff; color: white;}
    
    /* جدول محاسبه امتیاز جدید - خلاقانه */
    .creative-calculation {width: 100%; margin: 20px 0; background: #f8f9fa; border-radius: 10px; padding: 16px; border: 1px solid #e9ecef;}
    .calc-step {display: flex; align-items: center; margin-bottom: 12px; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e9ecef;}
    .calc-step-label {flex: 2; font-weight: bold; padding: 0 12px;}
    .calc-step-value {flex: 1; text-align: center; padding: 8px; background: #e9f5ff; border-radius: 4px; margin: 0 4px; min-width: 60px;}
    .calc-step-operator {flex: 0.5; text-align: center; font-weight: bold; font-size: 1.2rem;}
    .calc-final-row {display: flex; align-items: center; margin-top: 16px; padding: 12px; background: #e9f5ff; border-radius: 8px; border: 2px solid #cce5ff;}
    .calc-final-label {flex: 2; font-weight: bold; font-size: 1.1rem;}
    .calc-final-value {flex: 1; text-align: center; font-weight: bold; font-size: 1.3rem; background: #007bff; color: white; padding: 10px; border-radius: 6px;}
    .calc-multiply {display: flex; align-items: center; justify-content: center; margin: 12px 0; padding: 8px; background: #fff3cd; border-radius: 6px; border: 1px solid #ffe0b3;}
    .calc-multiply-text {font-weight: bold; margin: 0 8px;}
    
    /* گام پنجم - ردیف‌های گروه A با عکس */
    .unfavorable-group-a {display: flex; gap: 16px; margin-bottom: 16px;}
    .unfavorable-group-a .options {flex: 1;}
    .unfavorable-group-a .image-container {width: 200px;}
    .unfavorable-group-a .image-box {height: 120px; background: #f1f3f5; border: 1px solid #adb5bd; border-radius: 6px; display: flex; align-items: center; justify-content: center; overflow: hidden;}
    .unfavorable-group-a .image-box img {max-width: 100%; max-height: 100%; object-fit: contain;}
    .unfavorable-group-a .option-row {display: flex; margin-bottom: 8px; border: 1px solid #e9ecef; border-radius: 6px; overflow: hidden; cursor: pointer;}
    .unfavorable-group-a .option-row.selected {border-color: #007bff; background: #e9f5ff;}
    .unfavorable-group-a .option-text {flex: 1; padding: 10px;}
    .unfavorable-group-a .option-score {width: 60px; padding: 10px; text-align: center; background: #f8f9fa;}
    .unfavorable-group-a .option-row.selected .option-score {background: #cce5ff; font-weight: bold;}
    .unfavorable-group-a .option-row:hover {background: #f0f8ff;}
    
    /* استایل‌های پرینت */
    @media print {
      @page {
        size: portrait;
        margin: 0.5cm;
      }
      
      body {background: white; max-width: none; margin: 0; padding: 0; font-size: 10px; line-height: 1.3;}
      .no-print {display: none !important;}
      .card {box-shadow: none; border: 1px solid #ccc; page-break-inside: avoid; margin-bottom: 8px; padding: 8px;}
      h2 {color: black; font-size: 14px; margin-bottom: 12px;}
      h3 {font-size: 12px; margin-bottom: 8px; padding-bottom: 4px;}
      .score-box {background: #f0f0f0; border-color: #ccc; font-size: 10px; padding: 6px; margin-top: 8px;}
      .risk-legend td {font-weight: normal; font-size: 9px;}
      .risk-highlight {border-width: 2px !important;}
      
      /* تنظیمات جدول برای پرینت */
      table {font-size: 9px; margin-top: 6px;}
      th, td {padding: 4px;}
      
      /* تنظیمات جدول محاسبه برای پرینت */
      .creative-calculation {margin: 10px 0; padding: 8px;}
      .calc-step {margin-bottom: 6px; padding: 4px;}
      .calc-step-label, .calc-step-value, .calc-step-operator {font-size: 9px;}
      .calc-final-row {margin-top: 10px; padding: 8px;}
      .calc-final-label, .calc-final-value {font-size: 10px;}
      .calc-multiply {margin: 8px 0; padding: 4px;}
      
      /* اطمینان از جا شدن در یک صفحه */
      .card:last-child {page-break-after: avoid;}
    }
    
    /* کلاس برای مخفی کردن در پرینت */
    .no-print {display: block;}
    .print-summary {display: none;}
  </style>
</head>
<body>
  <div class="action-buttons no-print">
    <button class="btn btn-reset" onclick="resetForm()">بازنشانی فرم</button>
    <h2>فرم ارزیابی KIM-LHC</h2>
    <div style="width: 120px;"></div> <!-- برای حفظ تراز -->
  </div>

  <!-- مشخصات -->
  <div class="card" id="section-meta">
    <h3>مشخصات</h3>
    <div class="row">
      <div>
        <label>محل کار / فعالیت فرعی:</label>
        <input type="text" id="location" placeholder="مثلاً: انبار بسته‌بندی - خط ۲">
      </div>
      <div>
        <label>ارزیاب:</label>
        <input type="text" id="evaluator" placeholder="نام ارزیاب">
      </div>
    </div>
    <div class="row">
      <div>
        <label>مدت زمان روز کاری (ساعت):</label>
        <input type="number" id="workday" min="1" step="0.5" placeholder="مثلاً 8">
      </div>
      <div>
        <label>مدت زمان فعالیت فرعی (دقیقه):</label>
        <input type="number" id="subtaskDuration" min="0" step="1" placeholder="مثلاً 45">
      </div>
    </div>
    <div class="row">
      <div>
        <label>تاریخ (شمسی):</label>
        <div class="date-row">
          <select id="year"><option>سال</option></select>
          <select id="month"><option>ماه</option></select>
          <select id="day"><option>روز</option></select>
        </div>
      </div>
    </div>
  </div>

  <!-- گام اول: تعیین امتیاز زمان -->
  <div class="card no-print" id="step1">
    <h3>گام اول: تعیین امتیاز زمان</h3>
    <table id="timeTable">
      <thead>
        <tr>
          <th>تکرار [تا ... بار در هر فعالیت فرعی و روز کاری]</th>
          <td>5</td><td>20</td><td>50</td><td>100</td><td>150</td><td>220</td><td>300</td><td>500</td><td>750</td><td>1000</td><td>1500</td><td>2000</td><td>2500</td>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th>امتیاز زمان</th>
          <td class="selectable" data-score="1">1</td>
          <td class="selectable" data-score="1.5">1.5</td>
          <td class="selectable" data-score="2">2</td>
          <td class="selectable" data-score="2.5">2.5</td>
          <td class="selectable" data-score="3">3</td>
          <td class="selectable" data-score="3.5">3.5</td>
          <td class="selectable" data-score="4">4</td>
          <td class="selectable" data-score="5">5</td>
          <td class="selectable" data-score="6">6</td>
          <td class="selectable" data-score="7">7</td>
          <td class="selectable" data-score="8">8</td>
          <td class="selectable" data-score="9">9</td>
          <td class="selectable" data-score="10">10</td>
        </tr>
        <tr>
          <td colspan="14" style="text-align:right">
            <label>ورودی دستی (تعداد تکرار):</label>
            <input type="number" id="customRepetition" min="1" style="width:120px">
          </td>
        </tr>
      </tbody>
    </table>
    <div class="score-box" id="timeScore">امتیاز زمان: —</div>
  </div>

  <!-- گام دوم: تعیین امتیاز برای سایر شاخص‌ها (وزن بار مؤثر) -->
  <div class="card no-print" id="step2">
    <h3>گام دوم: تعیین امتیاز برای سایر شاخص‌ها</h3>
    
    <div class="gender-selection">
      <div class="gender-option" data-gender="male">حمل بار توسط مردان</div>
      <div class="gender-option" data-gender="female">حمل بار توسط زنان</div>
    </div>
    
    <table id="weightTable">
      <thead>
        <tr>
          <th>
            <span class="tooltip">وزن بار مؤثر (کیلوگرم)
              <span class="tip">وزن بار مؤثر" به بار کار فیزیکی اشاره دارد که کاربر واقعاً بایستی اعمال کند. هنگام کج کردن یک جعبه، فقط حدود 50% از وزن بار در نظر گرفته می شود و هنگام حمل بار به صورت دو نفره، حدود 60% از وزن بار برای هر نفر منظور می گردد. (در صورت افزایش نیازها در رابطه با کنترل بار و هماهنگی، باید بیش از 50% فرض شود).</span>
            </span>
          </th>
          <th id="weightScoreHeader">امتیاز بار</th>
        </tr>
      </thead>
      <tbody>
        <tr class="selectable" data-male="4" data-female="6"><td>3 تا 5</td><td class="weight-score">—</td></tr>
        <tr class="selectable" data-male="6" data-female="9"><td>&gt; 5 تا 10</td><td class="weight-score">—</td></tr>
        <tr class="selectable" data-male="8" data-female="12"><td>&gt; 10 تا 15</td><td class="weight-score">—</td></tr>
        <tr class="selectable" data-male="11" data-female="25"><td>&gt; 15 تا 20</td><td class="weight-score">—</td></tr>
        <tr class="selectable" data-male="15" data-female="75"><td>&gt; 20 تا 25</td><td class="weight-score">—</td></tr>
        <tr class="selectable" data-male="25" data-female="85"><td>&gt; 25 تا 30</td><td class="weight-score">—</td></tr>
        <tr class="selectable" data-male="35" data-female="100"><td>&gt; 30 تا 35</td><td class="weight-score">—</td></tr>
        <tr class="selectable" data-male="75" data-female="100"><td>&gt; 35 تا 40</td><td class="weight-score">—</td></tr>
      </tbody>
      <tfoot>
        <tr>
          <td>وارد کردن وزن بار به صورت دستی:</td>
          <td><input type="number" id="customWeight" min="1"> کیلوگرم</td>
        </tr>
      </tfoot>
    </table>
    <div class="score-box" id="weightScore">امتیاز بار مؤثر: —</div>
  </div>

  <!-- گام سوم: تعیین امتیاز پوسچر بدن -->
  <div class="card no-print" id="step3">
    <h3>گام سوم: تعیین امتیاز پوسچر بدن</h3>
    <p>حرکت می‌تواند در هر دو جهت انجام شود، به این معنا که نمادهای تصویری نشان داده‌شده می‌توانند هم به‌عنوان نقطه آغاز و هم به‌عنوان نقطه پایان جابجایی بار در نظر گرفته شوند. اگر چندین نماد تصویری در یک بخش قرار داشته باشند، این نمادها از نظر اهمیت برابر در نظر گرفته می‌شوند. علاوه بر این، چرخش/انحراف جانبی تنه، موقعیت بار/چنگش بار در فاصله از بدن، کار با دست‌های بالاتر از ارتفاع سر و چنگش بار در سطح شانه باید (به عنوان امتیازهای اضافی) در نظر گرفته شود. </p>

    <div class="posture-container">
      <table id="postureBase" class="posture-table-compact">
        <thead>
          <tr>
            <th>آغاز/پایان</th>
            <th>امتیاز</th>
            <th>آغاز/پایان</th>
            <th>امتیاز</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><img src="images/p1.png" alt=""></td>
            <td class="selectable" data-base="true" data-score="0">0</td>
            <td><img src="images/p3.png" alt=""></td>
            <td class="selectable" data-base="true" data-score="10">10</td>
          </tr>
          <tr>
            <td><img src="images/p5.png" alt=""></td>
            <td class="selectable" data-base="true" data-score="3">3</td>
            <td><img src="images/p7.png" alt=""></td>
            <td class="selectable" data-base="true" data-score="13">13</td>
          </tr>
          <tr>
            <td><img src="images/p9.png" alt=""></td>
            <td class="selectable" data-base="true" data-score="5">5</td>
            <td><img src="images/p11.png" alt=""></td>
            <td class="selectable" data-base="true" data-score="15">15</td>
          </tr>
          <tr>
            <td><img src="images/p13.png" alt=""></td>
            <td class="selectable" data-base="true" data-score="7">7</td>
            <td><img src="images/p15.png" alt=""></td>
            <td class="selectable" data-base="true" data-score="18">18</td>
          </tr>
          <tr>
            <td><img src="images/p17.png" alt=""></td>
            <td class="selectable" data-base="true" data-score="9">9</td>
            <td><img src="images/p19.png" alt=""></td>
            <td class="selectable" data-base="true" data-score="20">20</td>
          </tr>
        </tbody>
      </table>

      <table id="postureExtra">
        <thead>
          <tr><th>امتیازهای اضافی (حداکثر 6 امتیاز) فقط در صورت مرتبط بودن:</th><th>امتیاز</th></tr>
        </thead>
        <tbody>
          <tr class="selectable" data-extra="true" data-score="1"><td>1+ پیچش و/یا انحراف جانبی تنه گهگاهی قابل تشخیص</td><td>1</td></tr>
          <tr class="selectable" data-extra="true" data-score="3"><td>3+ پیچش و/یا انحراف جانبی تنه به طور مکرر/مداوم قابل تشخیص</td><td>3</td></tr>
          <tr class="selectable" data-extra="true" data-score="1"><td>1+ مرکز بار و/یا دست‌ها گهگاهی از بدن فاصله دارند</td><td>1</td></tr>
          <tr class="selectable" data-extra="true" data-score="3"><td>3+ مرکز بار و/یا دست‌ها به صور مکرر/ثابت از بدن فاصله دارد</td><td>3</td></tr>
          <tr class="selectable" data-extra="true" data-score="0.5"><td>0.5+ بازوها گهگاهی بالا می‌روند، دست‌ها بین ارتفاع آرنج و شانه</td><td>0.5</td></tr>
          <tr class="selectable" data-extra="true" data-score="1"><td>1+ بازوها مکرر/ثابت بالا می‌روند، دست‌ها بین آرنج و سطح شانه</td><td>1</td></tr>
          <tr class="selectable" data-extra="true" data-score="1"><td>1+ دست‌ها گهگاهی از ارتفاع شانه بالاتر می‌روند</td><td>1</td></tr>
          <tr class="selectable" data-extra="true" data-score="2"><td>2+ دست‌ها مکررا از ارتفاع شانه بالاتر می‌روند</td><td>2</td></tr>
        </tbody>
      </table>
    </div>
    <div class="score-box" id="postureScore">امتیاز پوسچر: —</div>
  </div>

  <!-- گام چهارم: تعیین امتیاز شرایط حمل بار -->
  <div class="card no-print" id="step4">
    <h3>گام چهارم: تعیین امتیاز شرایط حمل بار</h3>
    <table id="carryTable">
      <thead>
        <tr><th>شرح</th><th>امتیاز</th></tr>
      </thead>
      <tbody>
        <tr class="selectable" data-score="0"><td>بار با هر دو دست و به صورت متقارن حمل می‌شود</td><td>0</td></tr>
        <tr class="selectable" data-score="2"><td>بار به طور موقت با یک دست و/یا به صورت نامتقارن حمل می شود؛ توزیع نامتعادل بار بین دو دست</td><td>2</td></tr>
        <tr class="selectable" data-score="4"><td>بار عمدتاً با یک دست یا مرکز ثقل ناپایدار حمل می‌شود</td><td>4</td></tr>
      </tbody>
    </table>
    <div class="score-box" id="carryScoreBox">امتیاز شرایط حمل بار: —</div>
  </div>

  <!-- گام پنجم: شرایط کاری نامطلوب -->
  <div class="card no-print" id="step5">
    <h3>گام پنجم: تعیین امتیاز شرایط کاری نامطلوب</h3>
    <p>تعیین امتیاز شرایط کاری نامطلوب (فقط در صورت وجود امتیاز اختصاص داده شود):<br>
    شاخص‌هایی که در جداول ذکر نشده‌اند باید مناسب در نظر گرفته شوند. انحرافات نادر (وضعیت‌هایی که به ندرت رخ می‌دهند) را می‌توان نادیده گرفت.</p>

    <!-- ردیف‌های گروه A با عکس -->
    <div class="unfavorable-group-a">
      <div class="options">
        <div class="option-row" data-group="A" data-score="1">
          <div class="option-text">موقعیت و حرکت دست/بازو: گهگاهی در حداکثر دامنه حرکت دست/بازو</div>
          <div class="option-score">1</div>
        </div>
        <div class="option-row" data-group="A" data-score="2">
          <div class="option-text">موقعیت و حرکت دست/بازو: مکرر/ثابت در حداکثر دامنه حرکت دست/بازو</div>
          <div class="option-score">2</div>
        </div>
      </div>
      <div class="image-container">
        <div class="image-box">
          <img src="images/unfavorable-a.png" alt="موقعیت و حرکت دست/بازو">
        </div>
      </div>
    </div>

    <table id="unfavorableTable">
      <thead>
        <tr><th>شرح</th><th>امتیاز متوسط (IRP)</th></tr>
      </thead>
      <tbody>
        <tr class="selectable" data-group="B" data-score="1"><td style="text-align:right">انتقال/اعمال نیرو محدود شده: بارها به سختی قابل گرفتن هستند/نیروی بیشتری برای نگه داشتن مورد نیاز است/بدون دستگیره/از دستکش کار استفاده می شود.</td><td>1</td></tr>
        <tr class="selectable" data-group="B" data-score="2"><td style="text-align:right">انتقال/اعمال نیرو به طور قابل توجهی مانع شده است: بارها تقریباً غیرقابل چنگش هستند/لغزنده، نرم، لبه‌های تیز/بدون دسته/دسته نامناسب/ از دستکش‌های کار استفاده می‌شود</td><td>2</td></tr>
        <tr class="selectable" data-group="C" data-score="1"><td style="text-align:right">شرایط محیطی نامطلوب: شرایط نامطلوب آب و هوایی و/یا فشارهای فیزیکی ناشی از گرما، باد، سرما، رطوبت</td><td>1</td></tr>
        <tr class="selectable" data-group="D" data-score="1"><td style="text-align:right">شرایط فضایی محدود شده: فضای کاری کمتر از 1.5 متر مربع، کف زمین به طور معمول آلوده و کمی ناهموار است، شیب جزئی تا 5 درجه، تعادل بدنی کمی محدود شده، بار باید به دقت (در نقطه مشخص) قرار داده شود</td><td>1</td></tr>
        <tr class="selectable" data-group="D" data-score="2"><td style="text-align:right">شرایط فضایی نامطلوب: آزادی حرکت شدیدا محدود شده است یا فضای کافی برای حرکت وجود ندارد، کار در فضاهای بسته، کف زمین بسیار آلوده، ناهموار یا سنگ‌فرش خشن ، وجود پله‌/چاله‌ در مسیر، شیب تندتر از 5-10 درجه، حفظ تعادل سخت است، بار باید بسیار دقیق قرار داده شود.</td><td>2</td></tr>
        <tr class="selectable" data-group="E" data-score="1"><td style="text-align:right">لباس‌ها: فشار فیزیکی اضافی ناشی از استفاده از لباس‌ها یا تجهیزات دست و پاگیر (مثلاً هنگام پوشیدن بارانی‌های سنگین، لباس‌های محافظ تمام بدن، تجهیزات حفاظت تنفسی، کیف کمری ابزار یا موارد مشابه)</td><td>1</td></tr>
        <tr class="selectable" data-group="F" data-score="2"><td style="text-align:right">مشکلات ناشی از نگه داشتن/حمل کردن: بار باید بین > 5 تا 10 ثانیه نگه داشته شود یا در مسافتی بین > 2 متر تا 5 متر حمل شود.</td><td>2</td></tr>
        <tr class="selectable" data-group="F" data-score="5"><td style="text-align:right">مشکلات قابل توجه ناشی از نگه داشتن/حمل کردن: بار باید > 10 ثانیه نگه داشته شود یا در مسافتی > 5 متر حمل شود.</td><td>5</td></tr>
        <tr class="selectable" data-group="G" data-score="0"><td style="text-align:right">هیچ کدام: هیچ شرایط کاری نامطلوبی وجود ندارد</td><td>0</td></tr>
      </tbody>
    </table>
    <div class="score-box" id="unfavorableScore">امتیاز شرایط نامطلوب: —</div>
  </div>

  <!-- گام ششم: تنوع و تکرار وظایف -->
  <div class="card no-print" id="step6">
    <h3>گام ششم: تعیین امتیاز مربوط به تنوع و تکرار وظایف</h3>
    <table id="varietyTable">
      <thead>
        <tr><th>تعیین امتیاز مربوط به تنوع و تکرار وظایف</th><th>امتیاز</th></tr>
      </thead>
      <tbody>
        <tr class="selectable" data-score="0"><td style="text-align:right">مطلوب: تنوع زیاد فعالیت‌های فیزیکی در طول شیفت کاری به دلیل انجام کارهای مختلف (شامل فعالیت‌هایی با ماهیت متفاوت). همچنین، در طول شیفت، هیچ‌گونه فعالیت سنگین و طولانی‌مدت با ماهیت تکراری وجود ندارد.</td><td>0</td></tr>
        <tr class="selectable" data-score="2"><td style="text-align:right">محدود: تنوع کم در فعالیت‌های فیزیکی. همچنین، گاهی ممکن است فعالیت‌های سنگین کوتاه‌مدت با ماهیت تکراری وجود داشته باشد.</td><td>2</td></tr>
        <tr class="selectable" data-score="4"><td style="text-align:right">نامطلوب: تنوع کم در فعالیت‌های فیزیکی. همچنین، در طول شیفت، فعالیت‌های سنگین، فشرده و تکراری با ماهیت یکسان انجام می‌شود که گاهی با افزایش ناگهانی شدت یا مدت کار همراه است.</td><td>4</td></tr>
      </tbody>
    </table>
    <div class="score-box" id="varietyScore">امتیاز تنوع وظایف: —</div>
  </div>

  <!-- گام هفتم: محاسبه امتیاز سطح ریسک و اقدام اصلاحی -->
  <div class="card" id="step7">
    <h3>گام هفتم: محاسبه امتیاز سطح ریسک و اقدام اصلاحی</h3>
    
    <div class="creative-calculation">
      <div class="calc-step">
        <div class="calc-step-label">وزن بار مؤثر</div>
        <div class="calc-step-value" id="calc_weight">—</div>
        <div class="calc-step-operator">+</div>
        <div class="calc-step-label">شرایط حمل بار</div>
        <div class="calc-step-value" id="calc_carry">—</div>
        <div class="calc-step-operator">+</div>
        <div class="calc-step-label">پوسچر بدن</div>
        <div class="calc-step-value" id="calc_posture">—</div>
      </div>
      
      <div class="calc-step">
        <div class="calc-step-label">شرایط کاری نامطلوب</div>
        <div class="calc-step-value" id="calc_unfavorable">—</div>
        <div class="calc-step-operator">+</div>
        <div class="calc-step-label">تنوع و تکرار وظایف</div>
        <div class="calc-step-value" id="calc_variety">—</div>
        <div class="calc-step-operator">=</div>
        <div class="calc-step-label">مجموع شاخص‌ها</div>
        <div class="calc-step-value" id="calc_sum">—</div>
      </div>
      
      <div class="calc-multiply">
        <div class="calc-multiply-text">مجموع شاخص‌ها</div>
        <div class="calc-step-value" id="calc_sum_display">—</div>
        <div class="calc-multiply-text">×</div>
        <div class="calc-step-label">امتیاز زمان</div>
        <div class="calc-step-value" id="calc_time">—</div>
        <div class="calc-multiply-text">=</div>
      </div>
      
      <div class="calc-final-row">
        <div class="calc-final-label">امتیاز نهایی</div>
        <div class="calc-final-value" id="calc_final">—</div>
      </div>
    </div>
  </div>

  <!-- گام هشتم: جدول سطح ریسک با رنگ‌بندی -->
  <div class="card" id="step8">
    <h3>گام هشتم: سطح ریسک</h3>
    <p class="note">امتیاز ریسک محاسبه شده و جدول زیر، می‌توانند به عنوان مبنایی برای یک ارزیابی تقریبی استفاده شوند:</p>
    <table class="risk-legend">
      <thead>
        <tr>
          <th>ریسک</th>
          <th>سطح ریسک</th>
          <th>شدت بار *</th>
          <th>الف) احتمال اضافه بار فیزیکی<br>ب) پیامدهای احتمالی برای سلامتی</th>
          <th>اقدامات</th>
        </tr>
      </thead>
      <tbody>
        <tr id="risk1">
          <td>1</td>
          <td>کمتر از 20</td>
          <td>پایین</td>
          <td>الف) احتمال اضافه بار فیزیکی کم است.<br>ب) هیچ خطری برای سلامتی پیش‌بینی نمی‌شود.</td>
          <td>نیازی نیست.</td>
        </tr>
        <tr id="risk2">
          <td>2</td>
          <td>بین 20 تا کمتر از 50**</td>
          <td>کمی افزایش یافته</td>
          <td>الف) احتمال اضافه بار فیزیکی برای افرادی که تحمل کمی دارند، وجود دارد.<br>ب) خستگی، خستگی و اختلال سازگاری با شدت کم که در زمان فراغت جبران می‌شود.</td>
          <td>برای افراد کم تحمل، بازطراحی محل کار و سایر اقدامات پیشگیرانه ممکن است مفید باشد.</td>
        </tr>
        <tr id="risk3">
          <td>3</td>
          <td>بین 50 تا کمتر از 100</td>
          <td>به‌طور چشمگیری افزایش یافته</td>
          <td>الف) اضافه بار فیزیکی حتی برای افرادی با تحمل متوسط نیز ممکن است رخ دهد.<br>ب) اختلالات (معمولا همراه با درد) که ممکن است شامل اختلال در عملکرد اندام‌ها نیز باشد، در اکثر موارد موقتی هستند و تغییری در ساختار فیزیکی بدن ایجاد نمی‌کنند.</td>
          <td>بازطراحی و سایر اقدامات پیشگیرانه باید مورد بررسی قرار گیرند.</td>
        </tr>
        <tr id="risk4">
          <td>4</td>
          <td>برابر یا بیشتر از 100</td>
          <td>بالا</td>
          <td>الف) احتمال اضافه بار فیزیکی بالاست.<br>ب) آسیب‌های ساختاری قابل توجه با عواقب بیماری‌زا، همراه با اختلالات عملکردی شدید.</td>
          <td>بازطراحی الزامی است و سایر اقدامات پیشگیرانه نیز باید مدنظر قرار گیرند.</td>
        </tr>
      </tbody>
    </table>
    <div class="score-box" id="riskLevel">سطح ریسک: —</div>
  </div>

  <!-- دکمه چاپ در انتهای فرم -->
  <div class="action-buttons no-print">
    <button class="btn btn-print" onclick="printResults()">چاپ نتایج</button>
  </div>

  <script>
    // ===== تاریخ شمسی =====
    const SHAMSI_MONTHS=["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"];
    const CURRENT_SHAMSI_YEAR=1404;
    (function populateShamsi(){
      const y=document.getElementById('year'),m=document.getElementById('month'),d=document.getElementById('day');
      for(let i=CURRENT_SHAMSI_YEAR-3;i<=CURRENT_SHAMSI_YEAR+3;i++){const o=document.createElement('option');o.value=i;o.textContent=i;y.appendChild(o)}
      SHAMSI_MONTHS.forEach((mm,idx)=>{const o=document.createElement('option');o.value=idx+1;o.textContent=mm;m.appendChild(o)})
      for(let i=1;i<=31;i++){const o=document.createElement('option');o.value=i;o.textContent=i;d.appendChild(o)}
    })();

    // متغیرهای امتیازدهی
    let scores = {
      time: null,
      weight: null,
      posture: { base: null, extra: 0 },
      carry: null,
      unfavorable: 0,
      variety: null
    };

    // انتخاب جنسیت در گام دوم
    let selectedGender = 'male';
    
    document.querySelectorAll('.gender-option').forEach(option => {
      option.addEventListener('click', () => {
        document.querySelectorAll('.gender-option').forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');
        selectedGender = option.dataset.gender;
        updateWeightTableDisplay();
        updateWeightScore();
        updateFinalScores();
      });
    });
    
    // مقداردهی اولیه انتخاب جنسیت
    document.querySelector('.gender-option[data-gender="male"]').classList.add('selected');
    
    // به‌روزرسانی نمایش جدول وزن بر اساس جنسیت انتخاب شده
    function updateWeightTableDisplay() {
      const header = document.getElementById('weightScoreHeader');
      header.textContent = selectedGender === 'male' ? 'امتیاز بار برای مردان' : 'امتیاز بار برای زنان';
      
      document.querySelectorAll('#weightTable tbody .selectable').forEach(row => {
        const scoreCell = row.querySelector('.weight-score');
        const score = selectedGender === 'male' ? row.dataset.male : row.dataset.female;
        scoreCell.textContent = score;
      });
      
      // اگر قبلاً ردیفی انتخاب شده بود، امتیاز آن را به‌روزرسانی کن
      const selectedRow = document.querySelector('#weightTable tbody .selectable.selected');
      if (selectedRow) {
        scores.weight = selectedGender === 'male' ? 
          parseFloat(selectedRow.dataset.male) : 
          parseFloat(selectedRow.dataset.female);
      }
    }

    // ===== گام اول: امتیاز زمان با انتخاب و ورودی دستی =====
    const timeThresholds=[5,20,50,100,150,220,300,500,750,1000,1500,2000,2500];
    const timeScores=[1,1.5,2,2.5,3,3.5,4,5,6,7,8,9,10];
    let timeScoreVal=null, manualTime=false;
    
    function interp(x, xs, ys){ 
      if(x<=xs[0]) return ys[0]; 
      for(let i=1;i<xs.length;i++){ 
        if(x<=xs[i]){ 
          const r=(x-xs[i-1])/(xs[i]-xs[i-1]); 
          return ys[i-1]+r*(ys[i]-ys[i-1]); 
        } 
      } 
      return ys[ys.length-1]; 
    }
    
    document.querySelectorAll('#timeTable tbody tr:nth-child(1) .selectable').forEach(td=>{
      td.addEventListener('click',()=>{ 
        if(manualTime) return; 
        document.querySelectorAll('#timeTable .selectable').forEach(c=>c.classList.remove('selected')); 
        td.classList.add('selected'); 
        timeScoreVal=parseFloat(td.dataset.score); 
        scores.time = timeScoreVal;
        document.getElementById('timeScore').textContent='امتیاز زمان: '+timeScoreVal.toFixed(2); 
        updateFinalScores(); 
      });
    });
    
    document.getElementById('customRepetition').addEventListener('input',function(){ 
      const v=parseFloat(this.value); 
      if(!isNaN(v)&&v>0){ 
        manualTime=true; 
        document.querySelectorAll('#timeTable .selectable').forEach(c=>c.classList.remove('selected')); 
        timeScoreVal=interp(v,timeThresholds,timeScores); 
        scores.time = timeScoreVal;
        document.getElementById('timeScore').textContent='امتیاز زمان: '+timeScoreVal.toFixed(2); 
      } else { 
        manualTime=false; 
        timeScoreVal=null; 
        scores.time = null;
        document.getElementById('timeScore').textContent='امتیاز زمان: —'; 
      } 
      updateFinalScores(); 
    });

    // ===== گام دوم: وزن بار مؤثر با انتخاب/ورودی دستی =====
    const weightThresholds=[3,5,10,15,20,25,30,35,40];
    const maleScores=[4,4,6,8,11,15,25,35,75];
    const femaleScores=[6,6,9,12,25,75,85,100,100];
    
    function interpWeight(v,ths,sc){ 
      if(v<=ths[0]) return sc[0]; 
      for(let i=1;i<ths.length;i++){ 
        if(v<=ths[i]){ 
          const r=(v-ths[i-1])/(ths[i]-ths[i-1]); 
          return sc[i-1]+r*(sc[i]-sc[i-1]); 
        } 
      } 
      return sc[sc.length-1]; 
    }
    
    document.querySelectorAll('#weightTable tbody .selectable').forEach(row=>{
      row.addEventListener('click',()=>{ 
        document.querySelectorAll('#weightTable tbody .selectable').forEach(r=>r.classList.remove('selected')); 
        row.classList.add('selected'); 
        scores.weight = selectedGender === 'male' ? 
          parseFloat(row.dataset.male) : 
          parseFloat(row.dataset.female);
        updateWeightScore(); 
        updateFinalScores(); 
      });
    });
    
    document.getElementById('customWeight').addEventListener('input',function(){ 
      const v=parseFloat(this.value); 
      if(!isNaN(v)&&v>0){ 
        document.querySelectorAll('#weightTable tbody .selectable').forEach(r=>r.classList.remove('selected')); 
        scores.weight = selectedGender === 'male' ? 
          interpWeight(v,weightThresholds,maleScores) : 
          interpWeight(v,weightThresholds,femaleScores);
        updateWeightScore(); 
      } else { 
        scores.weight=null; 
        updateWeightScore(); 
      } 
      updateFinalScores(); 
    });

    // ===== گام سوم: پوسچر =====
    document.querySelectorAll('#postureBase [data-base]')
      .forEach(c=>c.addEventListener('click',()=>{ 
        document.querySelectorAll('#postureBase [data-base]').forEach(x=>x.classList.remove('selected')); 
        c.classList.add('selected'); 
        scores.posture.base=parseFloat(c.dataset.score); 
        updatePostureScore(); 
        updateFinalScores(); 
      }));
      
    // در بخش امتیازهای اضافی، کل ردیف قابل انتخاب است
    document.querySelectorAll('#postureExtra [data-extra]')
      .forEach(tr=>tr.addEventListener('click',()=>{ 
        const s=parseFloat(tr.dataset.score); 
        if(tr.classList.contains('selected')){ 
          tr.classList.remove('selected'); 
          scores.posture.extra -= s;
        } else { 
          if(scores.posture.extra + s <= 6){ 
            tr.classList.add('selected'); 
            scores.posture.extra += s;
          } else { 
            alert('حداکثر 6 امتیاز اضافی مجاز است'); 
          } 
        } 
        updatePostureScore(); 
        updateFinalScores(); 
      }));

    // ===== گام چهارم: شرایط حمل بار =====
    document.querySelectorAll('#carryTable .selectable').forEach(r=>r.addEventListener('click',()=>{ 
      document.querySelectorAll('#carryTable .selectable').forEach(x=>x.classList.remove('selected')); 
      if(!r.classList.contains('selected')){ 
        r.classList.add('selected'); 
        scores.carry=parseFloat(r.dataset.score); 
        updateCarryScore();
      } else { 
        scores.carry=null; 
        updateCarryScore();
      } 
      updateFinalScores(); 
    }));

    // ===== گام پنجم: شرایط کاری نامطلوب =====
    let unfavorableByGroup={};
    
    // ردیف‌های گروه A با فرمت جدید - کل ردیف قابل انتخاب است
    document.querySelectorAll('.unfavorable-group-a .option-row').forEach(row => {
      row.addEventListener('click', () => {
        const group = row.dataset.group;
        const score = parseFloat(row.dataset.score);
        
        // حذف انتخاب از سایر گزینه‌های گروه A
        document.querySelectorAll(`.unfavorable-group-a .option-row[data-group="${group}"]`).forEach(r => {
          r.classList.remove('selected');
        });
        
        row.classList.add('selected');
        unfavorableByGroup[group] = score;
        delete unfavorableByGroup['G']; // حذف گروه G اگر انتخاب شده بود
        recalcUnfavorable();
      });
    });
    
    // سایر ردیف‌های گام پنجم
    document.querySelectorAll('#unfavorableTable tbody .selectable').forEach(tr=>{
      tr.addEventListener('click',()=>{
        const group=tr.dataset.group; 
        const sc=parseFloat(tr.dataset.score);
        if(group==='G'){
          document.querySelectorAll('#unfavorableTable tbody .selectable').forEach(r=>r.classList.remove('selected'));
          // حذف انتخاب از گروه A
          document.querySelectorAll('.unfavorable-group-a .option-row').forEach(r => {
            r.classList.remove('selected');
          });
          unfavorableByGroup={G:0}; 
          tr.classList.add('selected');
        } else {
          // unselect any prior in same group
          document.querySelectorAll(`#unfavorableTable tbody .selectable[data-group="${group}"]`).forEach(r=>r.classList.remove('selected'));
          tr.classList.add('selected'); 
          unfavorableByGroup[group]=sc; 
          delete unfavorableByGroup['G'];
        }
        recalcUnfavorable();
      });
    });

    function recalcUnfavorable(){ 
      const sum=Object.values(unfavorableByGroup).reduce((a,b)=>a+b,0); 
      scores.unfavorable = sum;
      document.getElementById('unfavorableScore').textContent='امتیاز شرایط نامطلوب: '+ (isNaN(sum)?'—':sum); 
      updateFinalScores(); 
    }

    // ===== گام ششم: تنوع وظایف =====
    document.querySelectorAll('#varietyTable .selectable').forEach(r=>r.addEventListener('click',()=>{ 
      document.querySelectorAll('#varietyTable .selectable').forEach(x=>x.classList.remove('selected')); 
      r.classList.add('selected'); 
      scores.variety=parseFloat(r.dataset.score); 
      updateVarietyScore(); 
      updateFinalScores(); 
    }));

    // به‌روزرسانی امتیازهای نمایشی
    function updateWeightScore() {
      document.getElementById('weightScore').textContent = `امتیاز بار مؤثر: ${scores.weight !== null ? scores.weight.toFixed(2) : '—'}`;
    }

    function updatePostureScore() {
      const total = (scores.posture.base !== null ? scores.posture.base : 0) + scores.posture.extra;
      document.getElementById('postureScore').textContent = `امتیاز پوسچر: ${total.toFixed(2)}`;
    }

    function updateCarryScore() {
      document.getElementById('carryScoreBox').textContent = `امتیاز شرایط حمل بار: ${scores.carry !== null ? scores.carry.toFixed(2) : '—'}`;
    }

    function updateVarietyScore() {
      document.getElementById('varietyScore').textContent = `امتیاز تنوع وظایف: ${scores.variety !== null ? scores.variety.toFixed(2) : '—'}`;
    }

    // محاسبه امتیاز نهایی
    function updateFinalScores() {
      // به‌روزرسانی جدول محاسبه
      document.getElementById('calc_weight').textContent = scores.weight !== null ? scores.weight.toFixed(2) : '—';
      document.getElementById('calc_carry').textContent = scores.carry !== null ? scores.carry.toFixed(2) : '—';
      
      const postureTotal = (scores.posture.base !== null ? scores.posture.base : 0) + scores.posture.extra;
      document.getElementById('calc_posture').textContent = postureTotal.toFixed(2);
      
      document.getElementById('calc_unfavorable').textContent = scores.unfavorable.toFixed(2);
      document.getElementById('calc_variety').textContent = scores.variety !== null ? scores.variety.toFixed(2) : '—';
      
      // محاسبه مجموع امتیازهای شاخص
      const baseSum = postureTotal + (scores.carry !== null ? scores.carry : 0) + scores.unfavorable + (scores.variety !== null ? scores.variety : 0) + (scores.weight !== null ? scores.weight : 0);
      document.getElementById('calc_sum').textContent = baseSum.toFixed(2);
      document.getElementById('calc_sum_display').textContent = baseSum.toFixed(2);
      
      // نمایش امتیاز زمان
      document.getElementById('calc_time').textContent = scores.time !== null ? scores.time.toFixed(2) : '—';
      
      // محاسبه امتیاز نهایی
      const finalScore = scores.time !== null ? baseSum * scores.time : null;
      document.getElementById('calc_final').textContent = finalScore !== null ? finalScore.toFixed(2) : '—';
      
      // به‌روزرسانی سطح ریسک
      updateRiskLevel(finalScore);
    }

    // به‌روزرسانی سطح ریسک
    function updateRiskLevel(finalScore) {
      const riskLevelElement = document.getElementById('riskLevel');
      const riskRows = {
        risk1: document.getElementById('risk1'),
        risk2: document.getElementById('risk2'),
        risk3: document.getElementById('risk3'),
        risk4: document.getElementById('risk4')
      };
      
      // حذف کلاس‌های highlight قبلی
      Object.values(riskRows).forEach(row => {
        row.classList.remove('risk-highlight', 'risk1-highlight', 'risk2-highlight', 'risk3-highlight', 'risk4-highlight');
      });
      
      // تعیین سطح ریسک
      let riskLevel = '—';
      
      if (finalScore !== null) {
        if (finalScore < 20) riskLevel = '1 (کم)';
        else if (finalScore < 50) riskLevel = '2 (متوسط)';
        else if (finalScore < 100) riskLevel = '3 (زیاد)';
        else riskLevel = '4 (بسیار زیاد)';
        
        // هایلایت کردن ردیف مربوطه
        if (finalScore < 20) {
          riskRows.risk1.classList.add('risk-highlight', 'risk1-highlight');
        } else if (finalScore < 50) {
          riskRows.risk2.classList.add('risk-highlight', 'risk2-highlight');
        } else if (finalScore < 100) {
          riskRows.risk3.classList.add('risk-highlight', 'risk3-highlight');
        } else {
          riskRows.risk4.classList.add('risk-highlight', 'risk4-highlight');
        }
      }
      
      // نمایش سطح ریسک
      riskLevelElement.textContent = `سطح ریسک: ${riskLevel}`;
    }

    // بازنشانی فرم
    function resetForm() {
      if (confirm('آیا از بازنشانی فرم اطمینان دارید؟ تمام اطلاعات وارد شده پاک خواهد شد.')) {
        // پاک کردن تمام فیلدهای ورودی
        document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
          input.value = '';
        });
        
        // پاک کردن انتخاب‌های تاریخ
        document.getElementById('year').selectedIndex = 0;
        document.getElementById('month').selectedIndex = 0;
        document.getElementById('day').selectedIndex = 0;
        
        // پاک کردن تمام انتخاب‌ها
        document.querySelectorAll('.selected').forEach(el => {
          el.classList.remove('selected');
        });
        
        // بازنشانی امتیازها
        scores = {
          time: null,
          weight: null,
          posture: { base: null, extra: 0 },
          carry: null,
          unfavorable: 0,
          variety: null
        };
        
        unfavorableByGroup = {};
        
        // به‌روزرسانی نمایش امتیازها
        document.getElementById('timeScore').textContent = 'امتیاز زمان: —';
        updateWeightScore();
        updatePostureScore();
        document.getElementById('carryScoreBox').textContent = 'امتیاز شرایط حمل بار: —';
        document.getElementById('unfavorableScore').textContent = 'امتیاز شرایط نامطلوب: —';
        document.getElementById('varietyScore').textContent = 'امتیاز تنوع وظایف: —';
        
        // بازگرداندن انتخاب جنسیت به حالت پیش‌فرض
        document.querySelectorAll('.gender-option').forEach(opt => opt.classList.remove('selected'));
        document.querySelector('.gender-option[data-gender="male"]').classList.add('selected');
        selectedGender = 'male';
        updateWeightTableDisplay();
        
        updateFinalScores();
      }
    }

    // چاپ نتایج
    function printResults() {
      window.print();
    }

    // مقداردهی اولیه
    document.addEventListener('DOMContentLoaded', () => {
      updateWeightTableDisplay();
    });
  </script>
</body>
</html>