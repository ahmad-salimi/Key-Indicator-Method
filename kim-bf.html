<!doctype html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>فرم ارزیابی KIM-BF (واکنش‌گرا)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">
    <style>
        /* ---------------------- CSS Variables ---------------------- */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --card-border: #e9ecef;
            --text-color: #212529;
            --spacing: 16px;
            --border-radius: 8px;
            --table-header-bg: #e9ecef;
        }

        /* ---------------------- Base Styles ---------------------- */
        body {
            font-family: Vazirmatn, Tahoma, sans-serif;
            direction: rtl;
            text-align: right;
            max-width: 1400px;
            margin: 24px auto;
            color: var(--text-color);
            background-color: var(--bg-color);
            padding: 0 var(--spacing);
            line-height: 1.6;
        }
        
        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 2rem;
        }
        
        h2 {
            text-align: right;
            font-size: 1.6rem;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
            margin-top: 30px;
            margin-bottom: 20px;
        }

        h3 {
            margin: 0 0 16px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
            font-size: 1.3em;
        }

        /* ---------------------- Card & Form Styles ---------------------- */
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            padding: var(--spacing);
            margin-bottom: 24px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }
        
        .row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing);
            margin-bottom: var(--spacing);
        }
        
        .date-row {
            display: flex;
            gap: 8px;
        }
        
        .date-row select {
            flex: 1;
        }

        label {
            font-weight: 600;
            display: block;
            margin-bottom: 4px;
        }
        
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 10px 12px;
            font-family: inherit;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        /* ---------------------- Reset Button ---------------------- */
        .reset-container {
            text-align: right;
            margin-bottom: 20px;
        }
        
        #resetForm {
            padding: 12px 25px;
            font-weight: bold;
            border-radius: 6px;
            border: 1px solid var(--primary-color);
            background-color: var(--card-bg);
            color: var(--primary-color);
            cursor: pointer;
            font-family: Vazirmatn, Tahoma, sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        #resetForm:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* ---------------------- Table Styles ---------------------- */
        .score-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.85rem;
        }
        
        .score-table th, .score-table td {
            border: 1px solid #a9a9a9;
            padding: 10px 5px;
            text-align: center;
            vertical-align: middle;
        }
        
        .score-table thead th {
            background-color: var(--table-header-bg);
            font-weight: bold;
            color: var(--text-color);
        }
        
        .score-table .label-cell {
            font-weight: bold;
            background-color: #f0f8ff;
            min-width: 120px;
        }

        /* ---------------------- Selectable Cells ---------------------- */
        .selectable-cell {
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            user-select: none;
        }
        
        .selectable-cell:hover:not(.selected) {
            background-color: #f0f8ff;
        }
        
        .selectable-cell.selected {
            background-color: #e9f5ff !important;
            box-shadow: 0 0 0 3px var(--primary-color) inset;
            font-weight: bold;
        }

        /* ---------------------- Force Table Styles ---------------------- */
        .force-table-container {
            overflow-x: auto;
            margin-bottom: 10px;
        }
        
        .force-score-table {
            table-layout: fixed;
            width: 100%;
            font-size: 0.8rem;
        }
        
        .force-score-table th, .force-score-table td {
            border: 1px solid #a9a9a9;
            padding: 6px 3px;
            text-align: center;
            vertical-align: middle;
            background-color: #ffffff;
        }
        
        .force-score-table thead th {
            background-color: var(--table-header-bg);
            font-weight: bold;
        }
        
        .force-level-merged-cell {
            direction: rtl !important;
            text-align: center !important;
            width: 90px;
            background-color: #ffffff !important;
            font-weight: bold;
        }
        
        .force-desc-cell {
            direction: rtl !important;
            text-align: right !important;
            width: 35%; /* Increased width */
            padding-right: 8px;
            word-break: break-word;
            font-size: 0.75rem;
        }
        
        .force-desc-cell b {
            font-weight: bold;
            color: var(--text-color);
        }

        .header-extrap-input {
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 6px 4px;
            text-align: center;
            font-size: 0.7rem;
            direction: ltr;
            background-color: #fcfcfc;
        }
        .header-extrap-input::placeholder {
            color: #888;
            font-family: Vazirmatn, Tahoma, sans-serif;
            font-size: 0.65rem;
        }

        .extrap-output-cell {
            background-color: #fffacd !important;
            color: var(--primary-color);
            font-weight: bold;
        }
        
        /* ---------------------- Single Select Row Tables ---------------------- */
        .single-select-row-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .single-select-row-table th, .single-select-row-table td {
            border: 1px solid #a9a9a9;
            padding: 12px 8px;
            text-align: right;
            vertical-align: middle;
        }
        
        .single-select-row-table thead th {
            background-color: var(--table-header-bg);
            font-weight: bold;
            text-align: center;
        }
        
        .single-select-row-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .single-select-row-table tbody tr:hover:not(.selected-row) {
            background-color: #f8f9fa;
        }
        
        .single-select-row-table tbody tr.selected-row {
            background-color: #e9f5ff !important;
            box-shadow: 0 0 0 3px var(--primary-color) inset;
            font-weight: bold;
        }
        
        .single-select-row-table tbody td:last-child {
            text-align: center;
            font-weight: bold;
            width: 80px;
        }

        /* ---------------------- Posture Table Styles ---------------------- */
        .three-column-score-table-posture th:nth-child(1), .three-column-score-table-posture td:nth-child(1) { width: 15%; }
        .three-column-score-table-posture th:nth-child(2), .three-column-score-table-posture td:nth-child(2) { width: 65%; }
        .three-column-score-table-posture th:nth-child(3), .three-column-score-table-posture td:nth-child(3) { width: 20%; text-align: center; }
        
        .posture-image-cell {
            padding: 10px;
            text-align: center;
        }
        
        .posture-image {
            max-width: 100%;
            height: auto;
            max-height: 80px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* ---------------------- Unfavorable Conditions Styles ---------------------- */
        .unfavorable-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .unfavorable-table th, .unfavorable-table td {
            border: 1px solid #a9a9a9;
            padding: 10px 8px;
            text-align: right;
            vertical-align: top;
        }
        
        .unfavorable-table thead th {
            background-color: var(--table-header-bg);
            font-weight: bold;
            text-align: center;
        }
        
        .unfavorable-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .unfavorable-table tbody tr:hover:not(.selected-row) {
            background-color: #f8f9fa;
        }
        
        .unfavorable-table tbody tr.selected-row {
            background-color: #e9f5ff !important;
            box-shadow: 0 0 0 3px var(--primary-color) inset;
        }
        
        .unfavorable-table tbody td:last-child {
            text-align: center;
            font-weight: bold;
            width: 100px;
        }

        /* ---------------------- Special Unfavorable Group Styles ---------------------- */
        .unfavorable-group-a {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            margin-bottom: 15px;
            align-items: start;
        }
        
        .unfavorable-group-a .options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .unfavorable-group-a .option-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #a9a9a9;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .unfavorable-group-a .option-row:hover:not(.selected-row) {
            background-color: #f8f9fa;
        }
        
        .unfavorable-group-a .option-row.selected-row {
            background-color: #e9f5ff !important;
            box-shadow: 0 0 0 3px var(--primary-color) inset;
            font-weight: bold;
        }
        
        .unfavorable-group-a .option-text {
            flex: 1;
            text-align: right;
        }
        
        .unfavorable-group-a .option-score {
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }
        
        .unfavorable-group-a .image-container {
            display: flex;
            align-items: flex-start;
        }
        
        .unfavorable-group-a .image-box {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            background: white;
        }
        
        .unfavorable-group-a .image-box img {
            max-width: 120px;
            height: auto;
            display: block;
        }

        /* ---------------------- Score Box ---------------------- */
        .score-box {
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 16px;
            padding: 15px;
            background-color: #e9f5ff;
            border: 2px solid #cce5ff;
            border-radius: var(--border-radius);
            text-align: center;
            color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* ---------------------- Note Styles ---------------------- */
        .note {
            font-size: 0.85rem;
            color: var(--secondary-color);
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-right: 3px solid var(--secondary-color);
            border-radius: 4px;
        }
        
        .note strong {
            color: var(--primary-color);
        }

        .warning-note {
            border-right-color: #dc3545;
        }

        /* ---------------------- Custom Input ---------------------- */
        .custom-input {
            display: flex;
            align-items: center;
            margin-top: 15px;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .custom-input input {
            width: 120px;
            direction: ltr;
            text-align: center;
        }
        
        .custom-input span {
            font-size: 0.85rem;
            color: var(--secondary-color);
        }

        /* ---------------------- Gender Checkbox ---------------------- */
        .gender-checkbox {
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .gender-checkbox label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: normal;
        }
        
        .gender-checkbox input[type="checkbox"] {
            width: auto;
        }

        /* ---------------------- Final Calculation Table ---------------------- */
        .final-calc-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .final-calc-table th, .final-calc-table td {
            border: none;
            padding: 15px 12px;
            text-align: center;
            vertical-align: middle;
            border-bottom: 1px solid #dee2e6;
        }
        
        .final-calc-table thead th {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            font-weight: bold;
            font-size: 1.1em;
            border: none;
        }
        
        .final-calc-table tbody th {
            text-align: right;
            padding-right: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
            color: #495057;
        }
        
        .final-calc-table tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
            transition: background-color 0.3s ease;
        }
        
        .final-score-cell {
            font-size: 1.3em;
            font-weight: bold;
            background: linear-gradient(135deg, #fffacd 0%, #ffeaa7 100%) !important;
            color: #856404;
            border: 2px solid #ffd43b !important;
            border-radius: 8px;
        }
        
        .sub-total-cell {
            background: linear-gradient(135deg, #e6f7ff 0%, #b3e0ff 100%) !important;
            font-weight: bold;
            color: #0066cc;
        }
        
        .time-score-cell {
            background: linear-gradient(135deg, #e9f5ff 0%, #cce5ff 100%) !important;
            font-weight: bold;
            color: #0056b3;
        }

        /* ---------------------- Risk Table ---------------------- */
        .risk-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .risk-table th, .risk-table td {
            border: none;
            padding: 15px 12px;
            text-align: right;
            vertical-align: top;
            border-bottom: 1px solid #dee2e6;
        }
        
        .risk-table thead th {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            font-weight: bold;
            text-align: center;
            font-size: 1.1em;
        }
        
        .risk-table tbody td:first-child,
        .risk-table tbody td:nth-child(2),
        .risk-table tbody td:nth-child(3) {
            text-align: center;
            font-weight: bold;
        }

        .risk-row-1 { background: linear-gradient(135deg, #90ee90, #2e8b57); color: #155724 !important; }
        .risk-row-2 { background: linear-gradient(135deg, #ffff99, #ffd700); color: #856404 !important; }
        .risk-row-3 { background: linear-gradient(135deg, #ffb347, #ff8c00); color: #854d0e !important; }
        .risk-row-4 { background: linear-gradient(135deg, #ff6961, #dc143c); color: #721c24 !important; }

        .risk-table tbody tr.current-risk-level {
            box-shadow: 0 0 0 4px #000000 inset;
            transform: scale(1.02);
            transition: all 0.3s ease;
        }

        /* ---------------------- Print Button ---------------------- */
        .print-section {
            text-align: center;
            margin: 30px 0;
        }
        
        .print-btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
            font-family: Vazirmatn, Tahoma, sans-serif;
        }
        
        .print-btn:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        /* ---------------------- Print Styles ---------------------- */
        @media print {
            body { 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important;
                margin: 0;
                padding: 0;
            }
        }

        /* ---------------------- Responsive ---------------------- */
        @media (max-width: 768px) {
            .score-table, .force-score-table {
                font-size: 0.7rem;
            }
            
            .score-table th, .score-table td,
            .force-score-table th, .force-score-table td {
                padding: 4px 2px;
            }
            
            .custom-input {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .custom-input input {
                width: 100%;
            }
            
            .unfavorable-group-a {
                grid-template-columns: 1fr;
            }
            
            .unfavorable-group-a .image-container {
                justify-content: center;
            }
            
            .final-calc-table th, .final-calc-table td {
                padding: 10px 6px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>

    <h1>فرم ارزیابی KIM-BF (وظایف نیازمند اعمال نیرو با تمام بدن)</h1>
    
    <div class="reset-container">
        <button id="resetForm">بازنشانی فرم</button>
    </div>

    <!-- بخش مشخصات -->
    <div class="card">
        <h2>مشخصات</h2>
        <div class="row">
            <div>
                <label>محل کار / فعالیت فرعی:</label>
                <input id="location" placeholder="مثلاً: بخش مونتاژ - ایستگاه ۳" type="text">
            </div>
            <div>
                <label>ارزیاب:</label>
                <input id="evaluator" placeholder="نام ارزیاب" type="text">
            </div>
        </div>
        
        <div class="row">
            <div>
                <label>مدت زمان روز کاری (ساعت):</label>
                <input id="workday" type="number" min="1" step="0.5" placeholder="مثلاً 8">
            </div>
            <div>
                <label>مدت زمان فعالیت فرعی (دقیقه):</label>
                <input id="subtaskDuration" type="number" min="0" step="1" placeholder="مثلاً 45">
            </div>
            <div>
                <label>تاریخ (شمسی):</label>
                <div class="date-row">
                    <select id="year"><option value="">سال</option></select>
                    <select id="month"><option value="">ماه</option></select>
                    <select id="day"><option value="">روز</option></select>
                </div>
            </div>
        </div>
    </div>

    <!-- گام اول: تعیین امتیاز زمان -->
    <div class="card">
        <h2>گام اول: تعیین امتیاز زمان</h2>
        
        <div style="overflow-x: auto;">
            <table class="score-table">
                <thead>
                    <tr>
                        <th class="label-cell">کل مدت فعالیت فرعی [تا ... دقیقه] و/یا تکرار فعالیت فرعی در هر روز کاری:</th>
                        <th>تا 1</th>
                        <th>> 1 - 5</th>
                        <th>> 5 - 10</th>
                        <th>> 10 - 20</th>
                        <th>> 20 - 30</th>
                        <th>> 30 - 45</th>
                        <th>> 45 - 60</th>
                        <th>> 60 - 100</th>
                        <th>> 100 - 150</th>
                        <th>> 150 - 210</th>
                        <th>> 210 - 270</th>
                        <th>> 270 - 360</th>
                        <th>> 360 - 480</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="label-cell">امتیاز زمان</td>
                        <td data-score="1" class="selectable-cell single-select" data-group="time1">1</td>
                        <td data-score="1.5" class="selectable-cell single-select" data-group="time1">1.5</td>
                        <td data-score="2" class="selectable-cell single-select" data-group="time1">2</td>
                        <td data-score="2.5" class="selectable-cell single-select" data-group="time1">2.5</td>
                        <td data-score="3" class="selectable-cell single-select" data-group="time1">3</td>
                        <td data-score="3.5" class="selectable-cell single-select" data-group="time1">3.5</td>
                        <td data-score="4" class="selectable-cell single-select" data-group="time1">4</td>
                        <td data-score="5" class="selectable-cell single-select" data-group="time1">5</td>
                        <td data-score="6" class="selectable-cell single-select" data-group="time1">6</td>
                        <td data-score="7" class="selectable-cell single-select" data-group="time1">7</td>
                        <td data-score="8" class="selectable-cell single-select" data-group="time1">8</td>
                        <td data-score="9" class="selectable-cell single-select" data-group="time1">9</td>
                        <td data-score="10" class="selectable-cell single-select" data-group="time1">10</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="custom-input">
            <label for="timeCustom">یا وارد کردن مدت زمان دلخواه (دقیقه) برای درون‌یابی:</label>
            <input id="timeCustom" type="number" min="0.1" max="480" step="0.1" placeholder="مثلاً 125.5">
            <span>(امتیاز زمان بر اساس مقدار وارد شده محاسبه می‌شود)</span>
        </div>
        
        <div class="score-box" id="timeScore">امتیاز زمان: —</div>
        
        <div class="note">
            <strong>توضیحات:</strong><br>
            1) برای فعالیت‌های فرعی پیوسته، 2) برای فعالیت‌های فرعی گسسته. برای توضیحات در این زمینه به دستورالعمل مراجعه کنید.
        </div>
        
        <div class="note warning-note">
            <strong>توجه:</strong> اگر نیروهای انگشت-دست غالب باشند، فعالیت فرعی نیز باید با استفاده از <strong><a href="/kim-mho" style="color: #dc3545;">KIM-MHO</a></strong> ارزیابی شود!
        </div>
    </div>

    <!-- گام دوم: تعیین امتیاز برای سایر شاخص‌ها -->
    <div class="card">
        <h2>گام دوم: تعیین امتیاز برای سایر شاخص‌ها</h2>
        
        <!-- بخش اعمال نیرو -->
        <h3>تعیین امتیاز اعمال نیرو</h3>

        <div class="force-table-container">
            <table class="force-score-table">
                <thead>
                    <tr>
                        <th rowspan="3" class="force-level-merged-cell">سطح</th>
                        <th rowspan="3" class="force-desc-cell">نمونه‌های معمول به عنوان راهنمای طبقه‌بندی با هدف درک بهتر</th>
                        <th colspan="4">نگه داشتن</th>
                        <th colspan="5">حرکت</th>
                    </tr>
                    <tr>
                        <th colspan="4">متوسط زمان نگه داشتن [ثانیه]</th>
                        <th colspan="5">میانگین دفعات حرکت [عدد]</th>
                    </tr>
                    <tr>
                        <th><input type="number" id="extrapHoldingInput" class="header-extrap-input" placeholder=">45 ثانیه" min="45.1" step="0.1"></th>
                        <th>31-45</th>
                        <th>16-30</th>
                        <th>15 ≥</th>
                        <th>5 ></th>
                        <th>5-15</th>
                        <th>16-30</th>
                        <th>31-45</th>
                        <th><input type="number" id="extrapMovementInput" class="header-extrap-input" placeholder=">45 بار" min="45.1" step="0.1"></th>
                    </tr>
                </thead>
                <tbody>
                    <!-- ردیف کم -->
                    <tr>
                        <td class="force-level-merged-cell">کم</td>
                        <td class="force-desc-cell"><b>نیروهای کم:</b> به طور کلی، نیروهای تمام بدنی با شدت کم وجود ندارند. در صورت لزوم، این فعالیت‌های فرعی باید با استفاده از روش KIM-MHO ارزیابی شوند.</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                    </tr>
                    <!-- ردیف متوسط -->
                    <tr>
                        <td class="force-level-merged-cell">متوسط</td>
                        <td class="force-desc-cell"><b>نیروهای متوسط (تا 30 % FmaxM):</b> کار با ابزارهای دستی مانند سنگ فرز، اره‌زنجیری کوچک، شمشادزن یا دریل ضربه‌ای با وزن کمتر از 3 کیلوگرم / جابجایی بارها روی ریل‌های غلتکی با وزن کمتر از 20 کیلوگرم.</td>
                        <td class="extrap-output-cell" data-extrap-target="holding-1"></td>
                        <td class="selectable-cell" data-score="18">18</td>
                        <td class="selectable-cell" data-score="12">12</td>
                        <td class="selectable-cell" data-score="6">6</td>
                        <td class="selectable-cell" data-score="1.5">1.5</td>
                        <td class="selectable-cell" data-score="6">6</td>
                        <td class="selectable-cell" data-score="12">12</td>
                        <td class="selectable-cell" data-score="18">18</td>
                        <td class="extrap-output-cell" data-extrap-target="movement-1"></td>
                    </tr>
                    <!-- ردیف بالا -->
                    <tr>
                        <td class="force-level-merged-cell">بالا</td>
                        <td class="force-desc-cell"><b>نیروهای بالا (تا 50 % FmaxM):</b> کار با ابزارهای سنگین دستی، مانند سنگ فرز، اره‌ زنجیری بزرگ، دریل چکشی 3-8 کیلوگرم / کار با دستگاه‌های واترجت یا شن‌پاش‌ها/بیل‌زنی بارهای < 4 کیلوگرم / جابجایی بارها روی ریل‌های غلتکی 20-50 کیلوگرم / پرتاب بارهای < 3 کیلوگرم تا حداکثر 5 متر</td>
                        <td class="extrap-output-cell" data-extrap-target="holding-2"></td>
                        <td class="selectable-cell" data-score="25">25</td>
                        <td class="selectable-cell" data-score="17">17</td>
                        <td class="selectable-cell" data-score="8">8</td>
                        <td class="selectable-cell" data-score="2">2</td>
                        <td class="selectable-cell" data-score="8">8</td>
                        <td class="selectable-cell" data-score="17">17</td>
                        <td class="selectable-cell" data-score="25">25</td>
                        <td class="extrap-output-cell" data-extrap-target="movement-2"></td>
                    </tr>
                    <!-- ردیف بسیار بالا -->
                    <tr>
                        <td class="force-level-merged-cell">بسیار بالا</td>
                        <td class="force-desc-cell"><b>نیروهای بسیار بالا (تا 80 % FmaxM):</b> کار با ابزارهای دستی سنگین، مانند چکش‌های بادی (≥ 8 کیلوگرم) / بیل‌زنی بارهای 4-8 کیلوگرم / جابجایی بارها روی ریل‌های غلتکی > 50-100 کیلوگرم / پرتاب بارهای < 3 کیلوگرم تا حداکثر 10 متر یا 3-5 کیلوگرم حداکثر 5 متر</td>
                        <td class="selectable-cell" data-score="100">100</td>
                        <td class="selectable-cell" data-score="100">100</td>
                        <td class="selectable-cell" data-score="32">32</td>
                        <td class="selectable-cell" data-score="15">15</td>
                        <td class="selectable-cell" data-score="4">4</td>
                        <td class="selectable-cell" data-score="15">15</td>
                        <td class="selectable-cell" data-score="32">32</td>
                        <td class="selectable-cell" data-score="100">100</td>
                        <td class="selectable-cell" data-score="100">100</td>
                    </tr>
                    <!-- ردیف قله -->
                    <tr>
                        <td class="force-level-merged-cell">قله</td>
                        <td class="force-desc-cell"><b>نیروهای قله (بیش از 80 % FmaxM):</b> اعمال نیروی ضربه‌ای مانند هنگام کار با دیلم‌ها، پتک / غلتاندن بشکه‌های سنگین (> 200 کیلوگرم)، حمل و نقل اثاثیه سنگین / بیل‌زنی بارهای > 8 کیلوگرم / جابجایی بارها روی ریل‌های غلتکی > 100 کیلوگرم / پرتاب بارهای < 3 کیلوگرم بیش از 10 متر یا ≥ 3 کیلوگرم بیش از 5 متر</td>
                        <td class="selectable-cell" data-score="100">100</td>
                        <td class="selectable-cell" data-score="100">100</td>
                        <td class="selectable-cell" data-score="100">100</td>
                        <td class="selectable-cell" data-score="25">25</td>
                        <td class="selectable-cell" data-score="6">6</td>
                        <td class="selectable-cell" data-score="25">25</td>
                        <td class="selectable-cell" data-score="50">50</td>
                        <td class="selectable-cell" data-score="100">100</td>
                        <td class="selectable-cell" data-score="100">100</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="gender-checkbox">
            <label>
                <input type="checkbox" id="femaleMultiplier">
                برای زنان (امتیاز در 1.5 ضرب شود)
            </label>
        </div>
        
        <div class="score-box" id="forceScore">امتیاز اعمال نیرو: —</div>
        
        <div class="note">
            <strong>توضیحات:</strong><br>
            فعالیت فرعی باید مشاهده شود و امتیاز برای دسته‌های نیرو مشخص شود. مجموع نشان‌دهنده امتیاز کلی نیرو است.
        </div>

        <!-- بخش تقارن نیرو -->
        <h3 style="margin-top: 30px;">تعیین امتیاز تقارن نیرو</h3>
        <table class="single-select-row-table">
            <thead>
                <tr>
                    <th>تعیین امتیاز تقارن نیرو</th>
                    <th>امتیاز</th>
                </tr>
            </thead>
            <tbody>
                <tr data-score="0" class="single-select-row selected-row" data-group="force-symmetry">
                    <td>نیرو با هر دو دست و به صورت متقارن اعمال می‌شود</td>
                    <td>0</td>
                </tr>
                <tr data-score="2" class="single-select-row" data-group="force-symmetry">
                    <td>نیرو به طور موقت با یک دست و/یا به صورت نامتقارن اعمال می‌شود: توزیع نامتعادل نیرو بین دو دست</td>
                    <td>2</td>
                </tr>
                <tr data-score="4" class="single-select-row" data-group="force-symmetry">
                    <td>نیرو عمدتاً با یک دست اعمال می‌شود، توزیع یا جهت نامتعادل نیروهای هر دو دست</td>
                    <td>4</td>
                </tr>
            </tbody>
        </table>
        <div class="score-box" id="forceSymmetryScore">امتیاز تقارن نیرو: 0</div>

        <!-- بخش پوسچر بدن -->
        <h3 style="margin-top: 30px;">تعیین امتیاز پوسچر بدن</h3>
        <table class="single-select-row-table three-column-score-table-posture">
            <thead>
                <tr>
                    <th>تصویر</th>
                    <th>توضیحات</th>
                    <th>امتیاز</th>
                </tr>
            </thead>
            <tbody>
                <tr data-score="0" class="single-select-row selected-row" data-group="posture">
                    <td class="posture-image-cell">
                        <img src="images/posture-0.png" alt="پوسچر مناسب" class="posture-image" onerror="this.style.display='none'">
                    </td>
                    <td>
                        - صاف ایستاده تا موقعیتی که تنه کمی به جلو خم شده باشد (< 20 درجه)<br>
                        - بدون پیچش تنه
                    </td>
                    <td>0</td>
                </tr>
                <tr data-score="3" class="single-select-row" data-group="posture">
                    <td class="posture-image-cell">
                        <img src="images/posture-3.png" alt="پوسچر محدود" class="posture-image" onerror="this.style.display='none'">
                    </td>
                    <td>
                        - ایستاده، تنه بیشتر به جلو خم شده (20-60 درجه)<br>
                        - پیچش و/یا انحراف جانبی تنه گهگاهی قابل تشخیص است<br>
                        - دست‌ها گهگاهی بالای سطح شانه / دور از بدن
                    </td>
                    <td>3</td>
                </tr>
                <tr data-score="6" class="single-select-row" data-group="posture">
                    <td class="posture-image-cell">
                        <img src="images/posture-6.png" alt="پوسچر نامطلوب" class="posture-image" onerror="this.style.display='none'">
                    </td>
                    <td>
                        - ایستاده، تنه شدیدا به جلو (> 60 درجه) یا عقب خم شده<br>
                        - پیچش و/یا انحراف جانبی تنه مکررا قابل تشخیص<br>
                        - دست‌ها مکرراً بالای سطح شانه / دور از بدن<br>
                        - کار در حالت دراز کشیده با دست‌ها بالای/زیر بدن
                    </td>
                    <td>6</td>
                </tr>
                <tr data-score="9" class="single-select-row" data-group="posture">
                    <td class="posture-image-cell">
                        <img src="images/posture-9.png" alt="پوسچر کاملاً نامناسب" class="posture-image" onerror="this.style.display='none'">
                    </td>
                    <td>
                        - ترکیب خمش شدید به جلو یا عقب و انحراف جانبی/پیچش<br>
                        - پیچش و/یا انحراف جانبی تنه به طور ثابت که قابل تشخیص است<br>
                        - کار در حالت چمباتمه یا زانو زده<br>
                        - دست‌ها دائماً بالای سطح شانه / دور از بدن
                    </td>
                    <td>9</td>
                </tr>
            </tbody>
        </table>
        <div class="score-box" id="postureScore">امتیاز پوسچر بدن: 0</div>
        <div class="note">
            <strong>توضیحات:</strong><br>
            6) پوسچر‌های معمول بدن باید در نظر گرفته شوند. پوسچرهای بدنی نادر را می‌توان نادیده گرفت.
        </div>
        <div class="note warning-note">
            <strong>توجه:</strong> اگر امتیاز 9 انتخاب شد، توصیه می‌شود این فعالیت فرعی را همچنین با استفاده از <strong><a href="/kim-abp" style="color: #dc3545;">KIM-ABP</a></strong> ارزیابی کنید!
        </div>

        <!-- بخش شرایط کاری نامطلوب -->
        <h3 style="margin-top: 30px;">تعیین امتیاز شرایط کاری نامطلوب</h3>
        
        <!-- گروه A با عکس -->
        <div class="unfavorable-group-a">
            <div class="options">
                <div class="option-row" data-group="unfavorable-A" data-score="1">
                    <div class="option-text">موقعیت و حرکت دست/بازو: گهگاهی در حداکثر دامنه حرکت دست/بازو</div>
                    <div class="option-score">1</div>
                </div>
                <div class="option-row" data-group="unfavorable-A" data-score="2">
                    <div class="option-text">موقعیت و حرکت دست/بازو: مکرر/ثابت در حداکثر دامنه حرکت دست/بازو</div>
                    <div class="option-score">2</div>
                </div>
            </div>
            <div class="image-container">
                <div class="image-box">
                    <img src="images/unfavorable-a.png" alt="موقعیت و حرکت دست/بازو" class="posture-image" style="max-height: 300px; max-width: 400px; onerror="this.style.display='none'">
                </div>
            </div>
        </div>

        <table class="unfavorable-table">
            <thead>
                <tr>
                    <th>تعیین امتیاز شرایط کاری نامطلوب (فقط در صورت کاربرد مشخص کنید)</th>
                    <th>امتیاز متوسط (IRP)</th>
                </tr>
            </thead>
            <tbody>
                <tr data-score="1" class="single-select-row" data-group="unfavorable-B">
                    <td>انتقال/اعمال نیرو محدود شده: بارها به سختی قابل چنگش هستند/نیروی بیشتری برای نگه داشتن مورد نیاز است/بدون دستگیره/از دستکش کار استفاده می شود.</td>
                    <td>1</td>
                </tr>
                <tr data-score="2" class="single-select-row" data-group="unfavorable-B">
                    <td>انتقال/اعمال نیرو به طور قابل توجهی مختل شده است: بارها تقریباً غیرقابل چنگش هستند/لغزنده، نرم، لبه‌های تیز/بدون دسته/دسته نامناسب/ از دستکش‌های کار استفاده می‌شود</td>
                    <td>2</td>
                </tr>
                <tr data-score="1" class="single-select-row" data-group="unfavorable-C">
                    <td>شرایط محیطی محدود: قرار گرفتن در معرض گرما، سرما و/یا ارتعاش</td>
                    <td>1</td>
                </tr>
                <tr data-score="2" class="single-select-row" data-group="unfavorable-C">
                    <td>شرایط محیطی نامطلوب: قرار گرفتن در معرض گرما، سرما و/یا ارتعاش شدید</td>
                    <td>2</td>
                </tr>
                <tr data-score="1" class="single-select-row" data-group="unfavorable-D">
                    <td>نیاز به تلاش بیشتر ناشی از شرایط فضایی محدود: تعادل محدود و/یا فضای محدود برای حرکت، مانند ارتفاع بسیار کم یا فضای کاری کمتر از 1.5 متر مربع / کف زمین کمی لغزنده، شیب جزئی (تا 5 درجه)، وجود موانع در فضای کاری.</td>
                    <td>1</td>
                </tr>
                <tr data-score="2" class="single-select-row" data-group="unfavorable-D">
                    <td>نیاز به تلاش بیشتر ناشی از شرایط فضایی نامطلوب: تعادل و/یا آزادی حرکت به شدت محدود شده است، به عنوان مثال هنگام کار در فضاهای بسیار تنگ / کف بسیار لغزنده/ناهموار، شیب تندتر (> 5 درجه)</td>
                    <td>2</td>
                </tr>
                <tr data-score="2" class="single-select-row" data-group="unfavorable-E">
                    <td>لباس‌ها: بار اضافی ناشی از پوشیدن لباس‌ها و تجهیزات حفاظتی سنگین و محدودکننده (PPE) (به‌عنوان مثال لباس‌های محافظ در برابر گرما، لباس‌های محافظ در برابر مواد شیمیایی، تجهیزات تنفسی سنگین (گروه 3))</td>
                    <td>2</td>
                </tr>
                <tr data-score="0" class="single-select-row selected-row" data-group="unfavorable-none">
                    <td>هیچ کدام: هیچ شرایط کاری نامطلوبی وجود ندارد</td>
                    <td>0</td>
                </tr>
            </tbody>
        </table>
        <div class="score-box" id="unfavorableScore">امتیاز شرایط کاری نامطلوب: 0</div>
        <div class="note">
            <strong>توضیحات:</strong><br>
            سایر شاخص‌های ذکر نشده در جداول باید به طور مناسب در نظر گرفته شوند. انحرافات نادر را می‌توان نادیده گرفت.<br>
            8) لطفاً توجه داشته باشید: در صورتی که بارهای فیزیکی ناشی از ارتعاش وجود داشته باشد، باید به طور جداگانه ارزیابی شوند! نگاه کنید به (www.baua.de/vibration)
        </div>

        <!-- بخش تنوع و تکرار وظایف -->
        <h3 style="margin-top: 30px;">تعیین امتیاز مربوط به تنوع و تکرار وظایف</h3>
        <table class="single-select-row-table">
            <thead>
                <tr>
                    <th>تعیین امتیاز مربوط به تنوع و تکرار وظایف</th>
                    <th>امتیاز</th>
                </tr>
            </thead>
            <tbody>
                <tr data-score="0" class="single-select-row selected-row" data-group="task-variety">
                    <td>مطلوب: تنوع زیاد فعالیت‌های فیزیکی در طول شیفت کاری به دلیل انجام کارهای مختلف (شامل فعالیت‌هایی با ماهیت متفاوت). همچنین، در طول شیفت، هیچ‌گونه فعالیت سنگین و طولانی‌مدت با ماهیت تکراری وجود ندارد.</td>
                    <td>0</td>
                </tr>
                <tr data-score="2" class="single-select-row" data-group="task-variety">
                    <td>محدود: تنوع کم در فعالیت‌های فیزیکی. همچنین، گاهی ممکن است فعالیت‌های سنگین کوتاه‌مدت با ماهیت تکراری وجود داشته باشد.</td>
                    <td>2</td>
                </tr>
                <tr data-score="4" class="single-select-row" data-group="task-variety">
                    <td>نامطلوب: تنوع کم در فعالیت‌های فیزیکی. همچنین، در طول شیفت، فعالیت‌های سنگین، فشرده و تکراری با ماهیت یکسان انجام می‌شود که گاهی با افزایش ناگهانی شدت یا مدت کار همراه است.</td>
                    <td>4</td>
                </tr>
            </tbody>
        </table>
        <div class="score-box" id="taskVarietyScore">امتیاز تنوع و تکرار وظایف: 0</div>
    </div>

    <!-- گام سوم: محاسبه امتیاز سطح ریسک و اقدام اصلاحی -->
    <div class="card" id="step8-card">
        <h2>گام سوم: محاسبه امتیاز سطح ریسک و اقدام اصلاحی</h2>
        
        <h3>محاسبه امتیاز نهایی</h3>
        <div class="force-table-container">
            <table class="final-calc-table">
                <thead>
                    <tr>
                        <th style="width: 60%;">شرح محاسبه</th>
                        <th style="width: 40%;">مقدار</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th>امتیاز اعمال نیرو</th>
                        <td id="calc-force">—</td>
                    </tr>
                    <tr>
                        <th>امتیاز تقارن نیرو</th>
                        <td id="calc-symmetry">—</td>
                    </tr>
                    <tr>
                        <th>امتیاز پوسچر بدن</th>
                        <td id="calc-posture">—</td>
                    </tr>
                    <tr>
                        <th>امتیاز شرایط کاری نامطلوب</th>
                        <td id="calc-unfavorable">—</td>
                    </tr>
                    <tr>
                        <th>امتیاز تنوع و تکرار وظایف</th>
                        <td id="calc-variety">—</td>
                    </tr>
                    <tr class="sub-total-row">
                        <th>مجموع امتیازهای شاخص</th>
                        <td id="calc-sum-total" class="sub-total-cell">—</td>
                    </tr>
                    <tr>
                        <th>امتیاز زمان (ضریب)</th>
                        <td id="final-time-merged" class="time-score-cell">—</td>
                    </tr>
                    <tr class="final-score-row">
                        <th>امتیاز نهایی فعالیت فرعی</th>
                        <td id="final-score-total" class="final-score-cell">—</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="score-box" id="finalMaxScoreDisplay">
            🎯 امتیاز نهایی: <span id="final-max-score-value">—</span>
        </div>
    </div>

    <!-- جدول ریسک -->
    <div class="card" id="step9">
        <h2>جدول سطح ریسک و اقدامات اصلاحی</h2>
        <table class="risk-table" id="riskTable">
            <thead>
                <tr>
                    <th>ریسک</th>
                    <th>سطح ریسک</th>
                    <th>شدت بار</th>
                    <th>الف) احتمال اضافه بار فیزیکی<br>ب) پیامدهای احتمالی برای سلامتی</th>
                    <th>اقدامات</th>
                </tr>
            </thead>
            <tbody>
                <tr id="risk-row-1" data-min="0" data-max="19.99">
                    <td>1</td>
                    <td>کمتر از 20</td>
                    <td>پایین</td>
                    <td>
                        الف) احتمال اضافه بار فیزیکی کم است.<br>
                        ب) هیچ خطری برای سلامتی پیش‌بینی نمی‌شود.
                    </td>
                    <td>نیازی نیست.</td>
                </tr>
                <tr id="risk-row-2" data-min="20" data-max="49.99">
                    <td>2</td>
                    <td>بین 20 تا کمتر از 50</td>
                    <td>کمی افزایش یافته</td>
                    <td>
                        الف) احتمال اضافه بار فیزیکی برای افراد کم‌تحمل وجود دارد.<br>
                        ب) خستگی و اختلال سازگاری با شدت کم که در زمان فراغت جبران می‌شود.
                    </td>
                    <td>برای افراد کم تحمل، بازطراحی محل کار و سایر اقدامات پیشگیرانه ممکن است مفید باشد.</td>
                </tr>
                <tr id="risk-row-3" data-min="50" data-max="99.99">
                    <td>3</td>
                    <td>بین 50 تا کمتر از 100</td>
                    <td>به‌طور چشمگیری افزایش یافته</td>
                    <td>
                        الف) اضافه بار فیزیکی حتی برای افراد با تحمل متوسط نیز ممکن است رخ دهد.<br>
                        ب) اختلالات (معمولاً همراه با درد) که ممکن است شامل اختلال عملکرد اندام‌ها باشد، در اکثر موارد موقتی هستند.
                    </td>
                    <td>بازطراحی و اقدامات پیشگیرانه باید مورد بررسی قرار گیرند.</td>
                </tr>
                <tr id="risk-row-4" data-min="100" data-max="999999">
                    <td>4</td>
                    <td>برابر یا بیشتر از 100</td>
                    <td>بالا</td>
                    <td>
                        الف) احتمال اضافه بار فیزیکی بالاست.<br>
                        ب) آسیب‌های ساختاری قابل توجه با عواقب بیماری‌زا و اختلال عملکردی شدید.
                    </td>
                    <td>بازطراحی الزامی است و سایر اقدامات پیشگیرانه نیز باید مدنظر قرار گیرند.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="print-section">
        <button class="print-btn" onclick="printFinalResults()">
            🖨️ چاپ نتایج نهایی
        </button>
    </div>

    <script>
        // ---------------------- تاریخ شمسی ----------------------
        const SHAMSI_MONTHS = ["فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور", "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"];
        const CURRENT_SHAMSI_YEAR = 1404;

        function populateShamsiDate() {
            const yearSelect = document.getElementById('year');
            const monthSelect = document.getElementById('month');
            const daySelect = document.getElementById('day');
            
            for (let y = CURRENT_SHAMSI_YEAR - 3; y <= CURRENT_SHAMSI_YEAR + 3; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                yearSelect.appendChild(option);
            }
            
            SHAMSI_MONTHS.forEach((name, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.textContent = name;
                monthSelect.appendChild(option);
            });
            
            for (let d = 1; d <= 31; d++) {
                const option = document.createElement('option');
                option.value = d;
                option.textContent = d;
                daySelect.appendChild(option);
            }
        }

        // ---------------------- محاسبه امتیاز زمان ----------------------
        const timeThresholds = [1, 5, 10, 20, 30, 45, 60, 100, 150, 210, 270, 360, 480];
        const timeScores = [1, 1.5, 2, 2.5, 3, 3.5, 4, 5, 6, 7, 8, 9, 10];

        function interpolateTimeScore(duration) {
            if (duration <= 0) return 1;
            if (duration <= timeThresholds[0]) return timeScores[0];
            
            for (let i = 1; i < timeThresholds.length; i++) {
                if (duration <= timeThresholds[i]) {
                    const prevThreshold = timeThresholds[i - 1];
                    const currentThreshold = timeThresholds[i];
                    const prevScore = timeScores[i - 1];
                    const currentScore = timeScores[i];
                    
                    const ratio = (duration - prevThreshold) / (currentThreshold - prevThreshold);
                    return prevScore + ratio * (currentScore - prevScore);
                }
            }
            
            return timeScores[timeScores.length - 1];
        }

        function calcTimeScore() {
            let score = null;
            const customInput = document.getElementById('timeCustom').value;
            const customDuration = parseFloat(customInput);
            
            if (!isNaN(customDuration) && customDuration > 0) {
                score = interpolateTimeScore(customDuration);
                document.querySelectorAll('.selectable-cell[data-group="time1"]').forEach(cell => {
                    cell.classList.remove('selected');
                });
            } else {
                const selectedCell = document.querySelector('.selectable-cell.selected[data-group="time1"]');
                if (selectedCell) {
                    score = parseFloat(selectedCell.dataset.score);
                }
            }
            
            score = score === null ? 1 : score;
            document.getElementById('timeScore').innerHTML = `امتیاز زمان: ${score.toFixed(2)}`;
            calculateFinalScore();
            return score;
        }

        // ---------------------- منطق انتخاب سلول‌ها ----------------------
        function handleSingleSelectCell(event) {
            const cell = event.currentTarget;
            const group = cell.getAttribute('data-group');
            
            if (group === 'time1') {
                document.getElementById('timeCustom').value = '';
                document.querySelectorAll(`.selectable-cell[data-group="${group}"]`).forEach(c => {
                    c.classList.remove('selected');
                });
                cell.classList.add('selected');
                calcTimeScore();
            }
        }

        // ---------------------- منطق انتخاب امتیاز نیرو ----------------------
        function handleForceScoreSelection(event) {
            const cell = event.currentTarget;
            if (cell.textContent.trim() === '-' || cell.textContent.trim() === '') return;

            // Deselect all other cells in the entire force table
            document.querySelectorAll('.force-score-table .selectable-cell').forEach(c => {
                if (c !== cell) {
                    c.classList.remove('selected');
                }
            });

            cell.classList.toggle('selected');
            updateForceScoresAndDisplay();
        }


        // ---------------------- منطق برون‌یابی ----------------------
        function calculateExtrapolationScore(t, type, row) {
            if (t <= 45) return null;
            let y;
            if (row === 1) { // ردیف دوم (نیروهای متوسط)
                y = 0.4 * t; // فرمول برای a و c
            } else if (row === 2) { // ردیف سوم (نیروهای بالا)
                y = (17/30) * t - 0.5; // فرمول برای b و d
            }
            return y ? Math.min(y, 100).toFixed(1) : null;
        }
        
        function handleExtrapolationInput(event) {
            const input = event.target;
            const type = input.id.includes('Holding') ? 'holding' : 'movement';
            const t = parseFloat(input.value);

            // محاسبه برای ردیف متوسط
            const score1 = calculateExtrapolationScore(t, type, 1);
            const targetCell1 = document.querySelector(`[data-extrap-target="${type}-1"]`);
            updateExtrapCell(targetCell1, score1);
            
            // محاسبه برای ردیف بالا
            const score2 = calculateExtrapolationScore(t, type, 2);
            const targetCell2 = document.querySelector(`[data-extrap-target="${type}-2"]`);
            updateExtrapCell(targetCell2, score2);

            updateForceScoresAndDisplay();
        }

        function updateExtrapCell(cell, score) {
            if (score !== null) {
                cell.textContent = score;
                cell.dataset.score = score;
                cell.classList.add('selectable-cell');
            } else {
                cell.textContent = '';
                delete cell.dataset.score;
                cell.classList.remove('selectable-cell', 'selected');
            }
        }

        // ---------------------- محاسبه و نمایش امتیاز نیرو ----------------------
        function updateForceScoresAndDisplay() {
            let selectedScore = 0;
            const selectedCell = document.querySelector('.force-score-table .selectable-cell.selected');

            if (selectedCell) {
                const scoreText = selectedCell.dataset.score || selectedCell.textContent.trim();
                if (scoreText && !isNaN(parseFloat(scoreText))) {
                    selectedScore = parseFloat(scoreText);
                }
            }

            const femaleMultiplier = document.getElementById('femaleMultiplier').checked ? 1.5 : 1;
            const finalScore = selectedScore * femaleMultiplier;

            document.getElementById('forceScore').textContent = `امتیاز اعمال نیرو: ${finalScore.toFixed(1)}`;
            calculateFinalScore();
        }

        // ---------------------- منطق انتخاب ردیف‌های تکی ----------------------
        function handleRowSelection(event) {
            const row = event.currentTarget;
            const group = row.getAttribute('data-group');
            if (!group) return;

            if (group.startsWith('unfavorable-')) {
                const groupType = group.split('-')[1];
                
                if (groupType === 'none') {
                    document.querySelectorAll('.option-row.selected-row, .single-select-row.selected-row[data-group^="unfavorable-"]').forEach(el => el.classList.remove('selected-row'));
                    row.classList.add('selected-row');
                } else {
                    document.querySelector('[data-group="unfavorable-none"]')?.classList.remove('selected-row');
                    
                    const isSelected = row.classList.contains('selected-row');
                    document.querySelectorAll(`[data-group="${group}"]`).forEach(el => el.classList.remove('selected-row'));
                    
                    if (!isSelected) {
                        row.classList.add('selected-row');
                    }
                }
            } else {
                const isSelected = row.classList.contains('selected-row');
                document.querySelectorAll(`.single-select-row[data-group="${group}"]`).forEach(r => r.classList.remove('selected-row'));
                if (!isSelected) {
                    row.classList.add('selected-row');
                }
            }

            const scoreBoxIds = {
                'force-symmetry': 'forceSymmetryScore',
                'posture': 'postureScore',
                'task-variety': 'taskVarietyScore'
            };
            
            if (scoreBoxIds[group]) {
                const selectedRow = document.querySelector(`.single-select-row[data-group="${group}"].selected-row`);
                const newScore = selectedRow ? parseFloat(selectedRow.dataset.score) : 0;
                document.getElementById(scoreBoxIds[group]).innerHTML = `${group === 'task-variety' ? 'امتیاز تنوع و تکرار وظایف' : group === 'force-symmetry' ? 'امتیاز تقارن نیرو' : 'امتیاز پوسچر بدن'}: ${newScore}`;
            }
            
            updateUnfavorableScore();
            calculateFinalScore();
        }

        // ---------------------- محاسبه امتیاز شرایط نامطلوب ----------------------
        function updateUnfavorableScore() {
            let totalScore = 0;
            if (document.querySelector('[data-group="unfavorable-none"].selected-row')) {
                totalScore = 0;
            } else {
                document.querySelectorAll('.option-row.selected-row, .single-select-row.selected-row[data-group^="unfavorable-"]').forEach(el => {
                     totalScore += parseFloat(el.dataset.score);
                });
            }
            document.getElementById('unfavorableScore').textContent = `امتیاز شرایط کاری نامطلوب: ${totalScore}`;
            return totalScore;
        }

        // ---------------------- محاسبه نهایی ----------------------
        function calculateFinalScore() {
            const timeScore = parseFloat(document.getElementById('timeScore').textContent.replace(/[^\d.-]/g, '')) || 1;
            const forceScore = parseFloat(document.getElementById('forceScore').textContent.replace(/[^\d.-]/g, '')) || 0;
            const symmetryScore = parseFloat(document.getElementById('forceSymmetryScore').textContent.replace(/[^\d.-]/g, '')) || 0;
            const postureScore = parseFloat(document.getElementById('postureScore').textContent.replace(/[^\d.-]/g, '')) || 0;
            const unfavorableScore = parseFloat(document.getElementById('unfavorableScore').textContent.replace(/[^\d.-]/g, '')) || 0;
            const varietyScore = parseFloat(document.getElementById('taskVarietyScore').textContent.replace(/[^\d.-]/g, '')) || 0;
            
            const totalSum = forceScore + symmetryScore + postureScore + unfavorableScore + varietyScore;
            const finalScore = totalSum * timeScore;

            document.getElementById('calc-force').textContent = forceScore.toFixed(1);
            document.getElementById('calc-symmetry').textContent = symmetryScore.toFixed(1);
            document.getElementById('calc-posture').textContent = postureScore.toFixed(1);
            document.getElementById('calc-unfavorable').textContent = unfavorableScore.toFixed(1);
            document.getElementById('calc-variety').textContent = varietyScore.toFixed(1);
            
            document.getElementById('calc-sum-total').textContent = totalSum.toFixed(1);
            document.getElementById('final-time-merged').textContent = timeScore.toFixed(2);
            document.getElementById('final-score-total').textContent = finalScore.toFixed(1);
            document.getElementById('final-max-score-value').textContent = finalScore.toFixed(1);
            
            updateRiskTable(finalScore);
        }

        function updateRiskTable(finalScore) {
            document.querySelectorAll('#riskTable tbody tr').forEach(row => {
                row.classList.remove('current-risk-level');
                const min = parseFloat(row.dataset.min);
                const max = parseFloat(row.dataset.max);
                if (finalScore >= min && finalScore <= max) {
                    row.classList.add('current-risk-level');
                }
            });
        }
        
        // ---------------------- چاپ ----------------------
        // ---------------------- چاپ ----------------------
function printFinalResults() {
    calculateFinalScore();
    
    const printWindow = window.open('', '_blank');
    
    const location = document.getElementById('location')?.value || '---';
    const evaluator = document.getElementById('evaluator')?.value || '---';
    const workday = document.getElementById('workday')?.value || '---';
    const subtaskDuration = document.getElementById('subtaskDuration')?.value || '---';
    const year = document.getElementById('year')?.value || '---';
    const month = document.getElementById('month')?.options[document.getElementById('month')?.selectedIndex]?.text || '---';
    const day = document.getElementById('day')?.value || '---';
    const date = `${year}/${month}/${day}`;
    
    // مقادیر محاسبات
    const calcForce = document.getElementById('calc-force')?.textContent || '—';
    const calcSymmetry = document.getElementById('calc-symmetry')?.textContent || '—';
    const calcPosture = document.getElementById('calc-posture')?.textContent || '—';
    const calcUnfavorable = document.getElementById('calc-unfavorable')?.textContent || '—';
    const calcVariety = document.getElementById('calc-variety')?.textContent || '—';
    const calcSumTotal = document.getElementById('calc-sum-total')?.textContent || '—';
    const finalTimeMerged = document.getElementById('final-time-merged')?.textContent || '—';
    const finalScoreTotal = document.getElementById('final-score-total')?.textContent || '—';
    const finalMaxScore = document.getElementById('final-max-score-value')?.textContent || '—';
    
    const printContent = `
        <!DOCTYPE html>
        <html lang="fa" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>گزارش نهایی ارزیابی KIM-BF</title>
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">
            <style>
                * { box-sizing: border-box; margin: 0; padding: 0; }
                body { 
                    font-family: Vazirmatn, Tahoma, sans-serif; 
                    direction: rtl; 
                    margin: 0.2cm; 
                    padding: 0; 
                    font-size: 10px; 
                    line-height: 1.1; 
                    background: white; 
                }
                .page-break { page-break-inside: avoid; break-inside: avoid; margin-bottom: 0.3cm; }
                .header { 
                    background: #007bff; 
                    color: white; 
                    padding: 8px; 
                    text-align: center; 
                    border-radius: 4px 4px 0 0;
                    margin-bottom: 0;
                }
                .info-grid { 
                    display: grid; 
                    grid-template-columns: 1fr 1fr; 
                    gap: 5px; 
                    padding: 8px; 
                    background: #f8f9fa; 
                    border: 1px solid #ddd;
                    border-top: none;
                    border-radius: 0 0 4px 4px;
                    margin-bottom: 0.3cm;
                }
                .section { 
                    border: 1px solid #ddd; 
                    border-radius: 4px; 
                    margin-bottom: 0.3cm; 
                    page-break-inside: avoid;
                }
                .section h2 { 
                    background: #e9ecef; 
                    padding: 6px 8px; 
                    margin: 0; 
                    font-size: 11px; 
                    border-bottom: 1px solid #ddd; 
                    color: #007bff;
                }
                .section-content { padding: 8px; }
                table { width: 100%; border-collapse: collapse; font-size: 8px; margin: 5px 0; }
                th, td { border: 1px solid #999; padding: 4px 3px; text-align: center; }
                thead th { background: #6c757d; color: white; font-weight: bold; }
                .final-calc-table tbody th { text-align: right; background: #f8f9fa; }
                .final-score-cell { background: #fffacd; font-weight: bold; }
                .risk-row-1 { background: #90ee90; color: #155724; }
                .risk-row-2 { background: #ffff99; color: #856404; }
                .risk-row-3 { background: #ffb347; color: #854d0e; }
                .risk-row-4 { background: #ff6961; color: #721c24; }
                .current-risk-level { box-shadow: 0 0 0 2px #000 inset; }
                .score-box { 
                    background: #e9f5ff; 
                    border: 1px solid #cce5ff; 
                    padding: 6px; 
                    margin: 5px 0; 
                    text-align: center; 
                    font-weight: bold; 
                    font-size: 10px;
                    border-radius: 3px;
                }
                @page { size: portrait; margin: 0.2cm; }
            </style>
        </head>
        <body>
            <!-- بخش مشخصات -->
            <div class="page-break">
                <div class="header">
                    <h2 style="margin:0; font-size:12px; color:white;">گزارش نهایی ارزیابی KIM-BF</h2>
                </div>
                <div class="info-grid">
                    <div><strong>محل کار:</strong> ${location}</div>
                    <div><strong>ارزیاب:</strong> ${evaluator}</div>
                    <div><strong>مدت روز کاری:</strong> ${workday} ساعت</div>
                    <div><strong>مدت فعالیت فرعی:</strong> ${subtaskDuration} دقیقه</div>
                    <div><strong>تاریخ:</strong> ${date}</div>
                </div>
            </div>
            
            <!-- بخش محاسبات نهایی -->
            <div class="section page-break">
                <h2>گام سوم: محاسبه امتیاز سطح ریسک و اقدام اصلاحی</h2>
                <div class="section-content">
                    <table class="final-calc-table">
                        <thead>
                            <tr><th>شرح محاسبه</th><th>مقدار</th></tr>
                        </thead>
                        <tbody>
                            <tr><th>امتیاز اعمال نیرو</th><td>${calcForce}</td></tr>
                            <tr><th>امتیاز تقارن نیرو</th><td>${calcSymmetry}</td></tr>
                            <tr><th>امتیاز پوسچر بدن</th><td>${calcPosture}</td></tr>
                            <tr><th>امتیاز شرایط کاری نامطلوب</th><td>${calcUnfavorable}</td></tr>
                            <tr><th>امتیاز تنوع و تکرار وظایف</th><td>${calcVariety}</td></tr>
                            <tr><th>مجموع امتیازهای شاخص</th><td style="background:#e6f7ff; font-weight:bold;">${calcSumTotal}</td></tr>
                            <tr><th>امتیاز زمان (ضریب)</th><td style="background:#e9f5ff; font-weight:bold;">${finalTimeMerged}</td></tr>
                            <tr><th>امتیاز نهایی فعالیت فرعی</th><td style="background:#fffacd; font-weight:bold;">${finalScoreTotal}</td></tr>
                        </tbody>
                    </table>
                    <div class="score-box">🎯 امتیاز نهایی: ${finalMaxScore}</div>
                </div>
            </div>
            
            <!-- بخش جدول ریسک -->
            <div class="section page-break">
                <h2>جدول سطح ریسک و اقدامات اصلاحی</h2>
                <div class="section-content">
                    <table class="risk-table">
                        <thead>
                            <tr>
                                <th>ریسک</th><th>سطح ریسک</th><th>شدت بار</th>
                                <th>الف) احتمال اضافه بار فیزیکی<br>ب) پیامدهای احتمالی برای سلامتی</th>
                                <th>اقدامات</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="risk-row-1 ${finalMaxScore >= 0 && finalMaxScore < 20 ? 'current-risk-level' : ''}">
                                <td>1</td><td>کمتر از 20</td><td>پایین</td>
                                <td>الف) احتمال اضافه بار فیزیکی کم است.<br>ب) هیچ خطری برای سلامتی پیش‌بینی نمی‌شود.</td>
                                <td>نیازی نیست.</td>
                            </tr>
                            <tr class="risk-row-2 ${finalMaxScore >= 20 && finalMaxScore < 50 ? 'current-risk-level' : ''}">
                                <td>2</td><td>بین 20 تا کمتر از 50</td><td>کمی افزایش یافته</td>
                                <td>الف) احتمال اضافه بار فیزیکی برای افراد کم‌تحمل وجود دارد.<br>ب) خستگی و اختلال سازگاری با شدت کم که در زمان فراغت جبران می‌شود.</td>
                                <td>برای افراد کم تحمل، بازطراحی محل کار و سایر اقدامات پیشگیرانه ممکن است مفید باشد.</td>
                            </tr>
                            <tr class="risk-row-3 ${finalMaxScore >= 50 && finalMaxScore < 100 ? 'current-risk-level' : ''}">
                                <td>3</td><td>بین 50 تا کمتر از 100</td><td>به‌طور چشمگیری افزایش یافته</td>
                                <td>الف) اضافه بار فیزیکی حتی برای افراد با تحمل متوسط نیز ممکن است رخ دهد.<br>ب) اختلالات (معمولاً همراه با درد) که ممکن است شامل اختلال عملکرد اندام‌ها باشد، در اکثر موارد موقتی هستند.</td>
                                <td>بازطراحی و اقدامات پیشگیرانه باید مورد بررسی قرار گیرند.</td>
                            </tr>
                            <tr class="risk-row-4 ${finalMaxScore >= 100 ? 'current-risk-level' : ''}">
                                <td>4</td><td>برابر یا بیشتر از 100</td><td>بالا</td>
                                <td>الف) احتمال اضافه بار فیزیکی بالاست.<br>ب) آسیب‌های ساختاری قابل توجه با عواقب بیماری‌زا و اختلال عملکردی شدید.</td>
                                <td>بازطراحی الزامی است و سایر اقدامات پیشگیرانه نیز باید مدنظر قرار گیرند.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(printContent);
    printWindow.document.close();
    
    setTimeout(() => {
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    }, 300);
}

        // ---------------------- مقداردهی اولیه ----------------------
        function init() {
            populateShamsiDate();
            
            document.querySelectorAll('.selectable-cell[data-group="time1"]').forEach(cell => cell.addEventListener('click', handleSingleSelectCell));
            document.querySelectorAll('.force-score-table .selectable-cell, .force-score-table .extrap-output-cell').forEach(cell => cell.addEventListener('click', handleForceScoreSelection));
            document.querySelectorAll('.single-select-row, .option-row').forEach(row => row.addEventListener('click', handleRowSelection));
            
            document.getElementById('extrapHoldingInput').addEventListener('input', handleExtrapolationInput);
            document.getElementById('extrapMovementInput').addEventListener('input', handleExtrapolationInput);
            
            document.getElementById('timeCustom').addEventListener('input', calcTimeScore);
            document.getElementById('femaleMultiplier').addEventListener('change', updateForceScoresAndDisplay);
            document.getElementById('resetForm').addEventListener('click', resetForm);
            
            resetForm(); // Call reset form to set initial state
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
