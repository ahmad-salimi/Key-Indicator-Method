<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>KIM-ABP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">
  <style>
    /* ---------------------- CSS Variables ---------------------- */
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --bg-color: #f8f9fa;
      --card-bg: #ffffff;
      --card-border: #e9ecef;
      --text-color: #212529;
      --spacing: 16px;
      --border-radius: 8px;
    }

    /* ---------------------- Base Styles ---------------------- */
    body {
      font-family: Vazirmatn, Tahoma, sans-serif;
      direction: rtl;
      text-align: right;
      max-width: 1200px;
      margin: 24px auto;
      color: var(--text-color);
      background-color: var(--bg-color);
      padding: 0 var(--spacing);
      line-height: 1.6;
    }
    h2 {
      text-align: center;
      margin-bottom: 24px;
      color: var(--primary-color);
      font-size: 1.8em;
    }
    h3 {
      margin: 0 0 16px;
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 8px;
      font-size: 1.3em;
    }
    h4 {
      margin: 16px 0 8px;
      color: var(--secondary-color);
    }

    /* ---------------------- Form Elements ---------------------- */
    .card {
      border: 1px solid var(--card-border);
      border-radius: var(--border-radius);
      padding: var(--spacing);
      margin-bottom: 24px;
      background: var(--card-bg);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); 
    }
    
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
      gap: var(--spacing);
      margin-bottom: var(--spacing);
    }
    .date-row {
      display: flex;
      gap: 8px; 
    }
    .date-row select {
      flex: 1; 
    }

    label {
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }
    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 10px 12px;
      font-family: inherit;
      border: 1px solid #ced4da;
      border-radius: 4px;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }
    
    /* ---------------------- Table Styles ---------------------- */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: right;
      vertical-align: middle;
      white-space: normal;
    }
    th {
      background: #e9ecef;
      text-align: center;
      font-weight: bold;
      color: var(--text-color);
    }
    
    /* ---------------------- Selection Styles ---------------------- */
    .selectable-cell {
      cursor: pointer;
      transition: background-color 0.2s, box-shadow 0.2s, color 0.2s, opacity 0.2s;
      user-select: none;
      text-align: center;
    }

    .selectable-cell:hover:not(.selected):not(.temp-disabled) {
        background-color: #f0f8ff; 
    }

    .selectable-cell.temp-disabled {
        cursor: not-allowed;
        background-color: #f7f7f7 !important;
        color: #999;
        opacity: 0.7; 
    }

    .selectable-cell.selected {
        background-color: #e9f5ff !important; 
        box-shadow: 0 0 0 3px var(--primary-color) inset;
        font-weight: bold;
    }

    /* Conditions Table Styles */
    .conditions-table .condition-row {
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .conditions-table .condition-row:hover:not(.selected) {
        background-color: #f8f9fa;
    }

    .conditions-table .condition-row.selected {
        background-color: #e9f5ff !important;
        box-shadow: 0 0 0 2px var(--primary-color) inset;
    }

    .conditions-table .frequency-option {
        display: inline-block;
        padding: 8px 12px;
        margin: 2px 4px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .conditions-table .frequency-option:hover {
        background-color: #f0f8ff;
        border-color: var(--primary-color);
    }

    .conditions-table .frequency-option.selected {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    /* Time Score Table */
    .time-score-table th, .time-score-table td {
        width: 7.69%; /* 100% / 13 columns */
        text-align: center;
        padding: 8px 4px;
    }
    .time-score-table .label-cell {
        font-weight: bold;
        background-color: #f0f8ff;
        min-width: 120px;
    }

    /* Posture Tables */
    .posture-table th, .posture-table td {
        padding: 8px;
        vertical-align: top;
    }
    .posture-table .duration-cell {
        text-align: center;
        min-width: 80px;
    }
    .posture-table .score-cell {
        text-align: center;
        min-width: 60px;
        font-weight: bold;
    }

    .posture-image {
        max-width: 100%;
        max-height: 80px;
        height: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        object-fit: contain;
        display: block;
        margin: 0 auto;
    }

    /* ---------------------- Score Box ---------------------- */
    .score-box {
      font-weight: bold;
      font-size: 1.2em;
      margin-top: 16px;
      padding: 15px;
      background-color: #e9f5ff; 
      border: 2px solid #cce5ff;
      border-radius: var(--border-radius);
      text-align: center;
      color: var(--primary-color);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    /* ---------------------- Risk Table Highlighting ---------------------- */
    .risk-low { background-color: #00cc44 !important; }     
    .risk-slight { background-color: #ffff66 !important; }   
    .risk-high { background-color: #ff9933 !important; }    
    .risk-very-high { background-color: #ff3333 !important; } 

    /* ---------------------- Print Button ---------------------- */
    .print-section {
      text-align: center;
      margin: 30px 0;
    }
    
    .print-btn {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 1.1em;
      font-weight: bold;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
      font-family: Vazirmatn, Tahoma, sans-serif;
    }
    
    .print-btn:hover {
      background: linear-gradient(135deg, #0056b3, #004085);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
    }

    /* ---------------------- Print Styles ---------------------- */
    @media print {
      * {
          -webkit-print-color-adjust: exact !important; 
          print-color-adjust: exact !important;
      }

      body > *:not(.print-container) {
        visibility: hidden;
        height: 0;
        overflow: hidden;
      }
      
      .print-container,
      .print-container * {
        visibility: visible;
        position: static !important;
      }
      
      .print-header {
        text-align: center;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 10px;
      }
      
      .print-header h2 {
        color: #007bff;
        margin-bottom: 5px;
        font-size: 20px;
      }
      
      .card {
        border: 1px solid #333;
        box-shadow: none;
        margin-bottom: 10px;
        page-break-inside: avoid;
      }
      
      .print-btn {
        display: none;
      }
      
      table {
        page-break-inside: avoid;
      }

      th, td {
          padding: 5px;
      }
      
      body {
        margin: 5px;
        padding: 5px;
        font-size: 12px;
      }
      
      #step8, #step9 {
          font-size: 13px;
          padding: 5px;
          margin-top: 10px;
      }
      
      .print-final-score { /* Specific print style for the final score box */
          margin-top: 10px;
          padding: 10px;
          font-size: 1em;
          page-break-inside: avoid;
          background-color: #e9f5ff; 
          border: 2px solid #cce5ff;
          border-radius: 8px;
          text-align: center;
          color: #007bff;
      }
    }

    .note {
      font-size: 0.9em;
      color: var(--secondary-color);
      margin-top: 8px;
      font-style: italic;
    }

    .section-title {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      padding: 10px 15px;
      border-radius: var(--border-radius);
      margin: 20px 0 10px 0;
      font-weight: bold;
    }

    .custom-input {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .custom-input input {
      width: 150px;
    }

    .posture-options {
      margin-top: 5px;
      font-size: 0.9em;
    }
    .posture-options label {
      display: inline;
      font-weight: normal;
      margin-left: 10px;
    }

    /* Calculation Table Styles */
    .new-calculation-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      table-layout: auto; 
    }
    .new-calculation-table th, .new-calculation-table td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center; /* Default for scores */
      vertical-align: middle;
      width: auto; 
    }
    .new-calculation-table th:first-child,
    .new-calculation-table td:first-child {
        width: 40%; 
    }
    .new-calculation-table th:not(:first-child),
    .new-calculation-table td:not(:first-child) {
        width: 20%; 
    }

    .new-calculation-table .empty-cell {
      border: none;
      background: transparent;
    }
    .new-calculation-table .label-cell {
      text-align: right; /* Specific for labels */
      font-weight: bold;
      background-color: #f8f9fa;
    }
    .new-calculation-table .total-cell {
      background-color: #f0f0f0;
      font-weight: bold;
    }
    .new-calculation-table .final-cell {
      background-color: #e9f5ff;
      color: #007bff;
      font-weight: bold;
      
    }
    #final-time-merged {
        text-align: center !important; /* Ensure center alignment for the merged cell */
    }
  </style>
</head>
<body>
html
<h2>
    روش شاخص کلیدی برای ارزیابی و طراحی بار کار فیزیکی پوسچر‌های بدنی نامناسب
    <br>
    KIM-ABP
</h2>

  <button id="resetForm" style="margin-bottom:20px;padding:10px 20px;font-weight:bold;">بازنشانی فرم</button>

  <div class="card">
    <h3>مشخصات</h3>
    <div class="row">
      <div>
        <label>محل کار / فعالیت فرعی:</label>
        <input id="location" placeholder="مثلاً: خط مونتاژ - ایستگاه ۵" type="text">
      </div>
      <div>
        <label>ارزیاب:</label>
        <input id="evaluator" placeholder="نام ارزیاب" type="text">
      </div>
    </div>
    
    <div class="row">
      <div>
        <label>مدت زمان روز کاری (ساعت):</label>
        <input id="workday" type="number" min="1" step="0.5" placeholder="مثلاً 8">
      </div>
      <div>
        <label>مدت زمان فعالیت فرعی (ساعت):</label>
        <input id="subtaskDuration" type="number" min="0" step="0.5" placeholder="مثلاً 4">
      </div>
      <div style="grid-column: span 1 / auto;">
        <label>تاریخ (شمسی):</label>
        <div class="date-row">
          <select id="year"><option value="">سال</option></select>
          <select id="month"><option value="">ماه</option></select>
          <select id="day"><option value="">روز</option></select>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>گام اول: تعیین امتیاز زمان</h3>
    <table class="time-score-table">
      <thead>
        <tr>
          <th class="label-cell">کل مدت این فعالیت فرعی در هر روز کاری [تا ... ساعت]</th>
          <th>تا 1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="label-cell">امتیاز زمان</td>
          <td data-score="1" class="selectable-cell single-select" data-group="time1">1</td>
          <td data-score="2" class="selectable-cell single-select" data-group="time1">2</td>
          <td data-score="3" class="selectable-cell single-select" data-group="time1">3</td>
          <td data-score="4" class="selectable-cell single-select" data-group="time1">4</td>
          <td data-score="5" class="selectable-cell single-select" data-group="time1">5</td>
          <td data-score="6" class="selectable-cell single-select" data-group="time1">6</td>
          <td data-score="7" class="selectable-cell single-select" data-group="time1">7</td>
          <td data-score="8" class="selectable-cell single-select" data-group="time1">8</td>
          <td data-score="9" class="selectable-cell single-select" data-group="time1">9</td>
          <td data-score="10" class="selectable-cell single-select" data-group="time1">10</td>
        </tr>
      </tbody>
    </table>
    
    <div class="custom-input">
      <label>ورودی دستی مدت زمان (ساعت):</label>
      <input id="timeCustom" type="number" min="0.1" step="0.1" placeholder="مثلاً 3.5">
    </div>
    
    <div class="score-box" id="timeScore">امتیاز زمان: —</div>
  </div>

  <div class="card">
    <h3>گام دوم: تعیین امتیاز برای سایر شاخص‌ها</h3>
    
    <div class="section-title">A - تعیین امتیاز بار وارده به کمر</div>
    <table class="posture-table">
      <thead>
        <tr>
          <th style="width:10%" rowspan="2">تصویر</th>
          <th style="width:45%" rowspan="2">پوسچر بدن هنگام کار بدون یا با اعمال نیروی کم</th>
          <th colspan="4" style="text-align: center;">مدت زمان به عنوان بخشی از فعالیت فرعی</th>
          <th style="width:8%" rowspan="2">امتیازها</th>
        </tr>
        <tr>
          <th style="width:8%">تا ¼ گهگاهی</th>
          <th style="width:8%">تا ½ مکرر</th>
          <th style="width:8%">تا ¾ غالباً</th>
          <th style="width:8%">¾< دائماً</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td rowspan="1">
            <img src="images/kimabp_back1.png" alt="کمر 1 - ایستاده صاف" class="posture-image" onerror="this.style.display='none'">
          </td>
          <td rowspan="1">پوسچر ایستاده با کمر صاف در حالت ایستاده، چمباتمه یا زانو زدن، که ممکن است با چند قدم راه رفتن یا حرکات بدن (تنه می‌تواند تا 20 درجه به جلو خم شود) همراه باشد؛ مانند کارکنان فروش و اپراتورهای ماشین‌آلات.</td>
          <td class="selectable-cell duration-cell" data-group="back-A1" data-score="2">2</td>
          <td class="selectable-cell duration-cell" data-group="back-A1" data-score="4">4</td>
          <td class="selectable-cell duration-cell" data-group="back-A1" data-score="6">6</td>
          <td class="selectable-cell duration-cell" data-group="back-A1" data-score="8">8</td>
          <td class="score-cell" id="score-A1" rowspan="1">—</td>
        </tr>
        <tr>
          <td rowspan="1">
            <img src="images/kimabp_back2.png" alt="کمر 2 - خمش متوسط" class="posture-image" onerror="this.style.display='none'">
          </td>
          <td rowspan="1">خمش تنه به جلو با زاویه متوسط (بین 20 تا 60 درجه) در حالت ایستاده، چمباتمه یا زانو زدن، یا خم شدن به عقب؛ مانند کارگران خطوط مرتب‌سازی محصولات غذایی.</td>
          <td class="selectable-cell duration-cell" data-group="back-A2" data-score="7">7</td>
          <td class="selectable-cell duration-cell" data-group="back-A2" data-score="15">15</td>
          <td class="selectable-cell duration-cell" data-group="back-A2" data-score="22">22</td>
          <td class="selectable-cell duration-cell" data-group="back-A2" data-score="30">30</td>
          <td class="score-cell" id="score-A2" rowspan="1">—</td>
        </tr>
        <tr>
          <td rowspan="1">
            <img src="images/kimabp_back3.png" alt="کمر 3 - خمش شدید" class="posture-image" onerror="this.style.display='none'">
          </td>
          <td rowspan="1">خمش شدید تنه به جلو (بیشتر از 60 درجه) در حالت ایستاده، چمباتمه یا زانو زده؛ مثلا هنگام بستن میلگرد در کار ساختمانی</td>
          <td class="selectable-cell duration-cell" data-group="back-A3" data-score="10">10</td>
          <td class="selectable-cell duration-cell" data-group="back-A3" data-score="20">20</td>
          <td class="selectable-cell duration-cell" data-group="back-A3" data-score="30">30</td>
          <td class="selectable-cell duration-cell" data-group="back-A3" data-score="40">40</td>
          <td class="score-cell" id="score-A3" rowspan="1">—</td>
        </tr>
        <tr>
          <td rowspan="1">
            <img src="images/kimabp_back4.png" alt="کمر 4 - نشستن اجباری" class="posture-image" onerror="this.style.display='none'">
          </td>
          <td rowspan="1">نشستن در پوسچر‌های اجباری، خمش تنه به جلو به طور متوسط تا شدید، معمولا با نگاه مداوم به یک نقطه؛ مانند کار با میکروسکوپ، هدایت جرثقیل‌ها، آندوسکوپی (پزشکی)، همچنین نشستن کف زمین.</td>
          <td class="selectable-cell duration-cell" data-group="back-A4" data-score="3">3</td>
          <td class="selectable-cell duration-cell" data-group="back-A4" data-score="6">6</td>
          <td class="selectable-cell duration-cell" data-group="back-A4" data-score="9">9</td>
          <td class="selectable-cell duration-cell" data-group="back-A4" data-score="12">12</td>
          <td class="score-cell" id="score-A4" rowspan="1">—</td>
        </tr>
        <tr>
          <td rowspan="1">
            <img src="images/kimabp_back5.png" alt="کمر 5 - نشستن متغیر" class="posture-image" onerror="this.style.display='none'">
          </td>
          <td rowspan="1">
            <div><strong>نشستن در یک پوسچر متغیر مانند کار اداری</strong></div>
            <div class="posture-options">
              <strong>تغییر به حالت ایستاده / راه رفتن:</strong>
              <div>
                <input type="radio" name="posture5-type" value="impossible" id="posture5-impossible" checked>
                <label for="posture5-impossible">ممکن نیست</label>
              </div>
              <div>
                <input type="radio" name="posture5-type" value="possible" id="posture5-possible">
                <label for="posture5-possible">ممکن است</label>
              </div>
            </div>
          </td>
          <td class="selectable-cell duration-cell posture5-duration" data-group="back-A5" data-score-impossible="2" data-score-possible="0.5">2</td>
          <td class="selectable-cell duration-cell posture5-duration" data-group="back-A5" data-score-impossible="4" data-score-possible="1">4</td>
          <td class="selectable-cell duration-cell posture5-duration" data-group="back-A5" data-score-impossible="6" data-score-possible="1.5">6</td>
          <td class="selectable-cell duration-cell posture5-duration" data-group="back-A5" data-score-impossible="8" data-score-possible="2">8</td>
          <td class="score-cell" id="score-A5" rowspan="1">—</td>
        </tr>
        <tr style="background-color: #f8f9fa;">
          <td colspan="6" style="text-align: right; font-weight: bold; border: none;">جمع امتیازهای بخش A</td>
          <td class="score-cell" id="total-back-score" style="font-weight: bold; background-color: #e9f5ff;">—</td>
        </tr>
      </tbody>
    </table>
    
    <div class="score-box" id="backScore">امتیاز بار وارده به کمر (A): —</div>
    <div class="note">لطفا توجه داشته باشید: برای پوسچر‌های دست/بازو، در صورت لزوم، بخش B را نیز تکمیل کنید! اگر کار در حالت چمباتمه و زانو زده انجام شود، بخش C نیز باید تکمیل شود!</div>

    <div class="section-title">B - تعیین امتیاز بار وارده به شانه‌ها و بازوها</div>
    <table class="posture-table">
      <thead>
        <tr>
          <th style="width:10%" rowspan="2">تصویر</th>
          <th style="width:45%" rowspan="2">هنگام کار بدون یا با اعمال نیروی کم</th>
          <th colspan="4" style="text-align: center;">مدت زمان به عنوان بخشی از فعالیت فرعی</th>
          <th style="width:8%" rowspan="2">امتیازها</th>
        </tr>
        <tr>
          <th style="width:8%">تا ¼</th>
          <th style="width:8%">تا ½</th>
          <th style="width:8%">تا ¾</th>
          <th style="width:8%">¾<</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td rowspan="1">
            <img src="images/kimabp_shoulder1.png" alt="شانه 1 - بازوهای بالا" class="posture-image" onerror="this.style.display='none'">
          </td>
          <td rowspan="1"><strong>بازوها بالا، دست‌ها بالای سطح شانه در حالت ایستاده</strong>، چمباتمه یا زانو زدن؛ مانند نصب دیوار خشک، دکوراسیون داخلی، برقکاری، نصب سیستم‌های تهویه، مونتاژ دستی، تعمیر و نگهداری</td>
          <td class="selectable-cell duration-cell" data-group="shoulder-B1" data-score="10">10</td>
          <td class="selectable-cell duration-cell" data-group="shoulder-B1" data-score="20">20</td>
          <td class="selectable-cell duration-cell" data-group="shoulder-B1" data-score="30">30</td>
          <td class="selectable-cell duration-cell" data-group="shoulder-B1" data-score="40">40</td>
          <td class="score-cell" id="score-B1" rowspan="1">—</td>
        </tr>
        <tr>
          <td rowspan="1">
            <img src="images/kimabp_shoulder2.png" alt="شانه 2 - بازوهای متوسط" class="posture-image" onerror="this.style.display='none'">
          </td>
          <td rowspan="1"><strong>بازوها بالا، دست‌ها پایین‌تر از سطح شانه یا دور از بدن در حالت ایستاده</strong>، چمباتمه یا زانو زدن بدون اینکه بازوها پشتیبانی شوند؛ مانند فعالیت‌های مرتب‌سازی در خط تولید</td>
          <td class="selectable-cell duration-cell" data-group="shoulder-B2" data-score="6">6</td>
          <td class="selectable-cell duration-cell" data-group="shoulder-B2" data-score="12">12</td>
          <td class="selectable-cell duration-cell" data-group="shoulder-B2" data-score="18">18</td>
          <td class="selectable-cell duration-cell" data-group="shoulder-B2" data-score="24">24</td>
          <td class="score-cell" id="score-B2" rowspan="1">—</td>
        </tr>
        <tr>
          <td rowspan="1">
            <img src="images/kimabp_shoulder3.png" alt="شانه 3 - دراز کشیده" class="posture-image" onerror="this.style.display='none'">
          </td>
          <td rowspan="1">
            <strong>به پشت دراز کشیده، بازوها بالای سر</strong>، مانند نقاشی سقف، کار مونتاژ، کف دو جداره کشتی، ساخت مخزن<br>
            <strong>به شکم دراز کشیده، بازوها جلوی / زیر بدن</strong>، مانند تعمیر ماشین
          </td>
          <td class="selectable-cell duration-cell" data-group="shoulder-B3" data-score="7">7</td>
          <td class="selectable-cell duration-cell" data-group="shoulder-B3" data-score="14">14</td>
          <td class="selectable-cell duration-cell" data-group="shoulder-B3" data-score="21">21</td>
          <td class="selectable-cell duration-cell" data-group="shoulder-B3" data-score="28">28</td>
          <td class="score-cell" id="score-B3" rowspan="1">—</td>
        </tr>
        <tr>
          <td rowspan="1">
            زمان باقی‌مانده
          </td>
          <td rowspan="1"><strong>بدون بار وارده به شانه‌ها/بازوها</strong></td>
          <td colspan="4" class="selectable-cell duration-cell" data-group="shoulder-B4" data-score="0" style="text-align:center;">0</td>
          <td class="score-cell" id="score-B4" rowspan="1">—</td>
        </tr>
        <tr style="background-color: #f8f9fa;">
          <td colspan="6" style="text-align: right; font-weight: bold; border: none;">جمع امتیازهای بخش B</td>
          <td class="score-cell" id="total-shoulder-score" style="font-weight: bold; background-color: #e9f5ff;">—</td>
        </tr>
      </tbody>
    </table>
    
    <div class="score-box" id="shoulderScore">امتیاز بار وارده به شانه‌ها و بازوها (B): —</div>
    <div class="note">لطفا توجه داشته باشید: اگر بار فیزیکی به دست/بازو وارد شود، فعالیت فرعی بایستی با استفاده از روش KIM-MHO نیز ارزیابی شود.</div>

    <div class="section-title">C - تعیین امتیاز بار وارده به زانوها/پاها</div>
    <table class="posture-table">
      <thead>
        <tr>
          <th style="width:10%" rowspan="2">تصویر</th>
          <th style="width:45%" rowspan="2">هنگام کار بدون اعمال نیرو یا با اعمال نیروی کم</th>
          <th colspan="4" style="text-align: center;">مدت زمان به عنوان بخشی از فعالیت فرعی</th>
          <th style="width:8%" rowspan="2">امتیازها</th>
        </tr>
        <tr>
          <th style="width:8%">تا ¼</th>
          <th style="width:8%">تا ½</th>
          <th style="width:8%">تا ¾</th>
          <th style="width:8%">¾<</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td rowspan="1">
            <img src="images/kimabp_knee1.png" alt="زانو 1 - ایستادن مداوم" class="posture-image" onerror="this.style.display='none'">
          </td>
          <td rowspan="1"><strong>ایستادن مداوم</strong>، همراه با چند قدم راه رفتن، مانند کارکنان فروش، اپراتورهای ماشین‌آلات</td>
          <td class="selectable-cell duration-cell" data-group="knee-C1" data-score="2">2</td>
          <td class="selectable-cell duration-cell" data-group="knee-C1" data-score="4">4</td>
          <td class="selectable-cell duration-cell" data-group="knee-C1" data-score="6">6</td>
          <td class="selectable-cell duration-cell" data-group="knee-C1" data-score="8">8</td>
          <td class="score-cell" id="score-C1" rowspan="1">—</td>
        </tr>
        <tr>
          <td rowspan="1">
            <img src="images/kimabp_knee2.png" alt="زانو 2 - چمباتمه و زانو زدن" class="posture-image" onerror="this.style.display='none'">
          </td>
          <td rowspan="1"><strong>چمباتمه زدن، زانو زدن یا نشستن چهارزانو</strong>، مانند نصب دیوار خشک، دکوراسیون داخلی، برقکاری، لوله کشی، جوشکاری دستی، برداشت محصولات، نصب کف‌پوش/کاشی‌، سنگ‌فرش، مونتاژ دستی و تعمیر و نگهداری</td>
          <td class="selectable-cell duration-cell" data-group="knee-C2" data-score="10">10</td>
          <td class="selectable-cell duration-cell" data-group="knee-C2" data-score="20">20</td>
          <td class="selectable-cell duration-cell" data-group="knee-C2" data-score="30">30</td>
          <td class="selectable-cell duration-cell" data-group="knee-C2" data-score="40">40</td>
          <td class="score-cell" id="score-C2" rowspan="1">—</td>
        </tr>
        <tr>
        </tr>
        <tr>
          <td rowspan="1">
            زمان باقی‌مانده
          </td>
          <td rowspan="1"><strong>بدون بار وارده به زانوها/پاها</strong></td>
          <td colspan="4" class="selectable-cell duration-cell" data-group="knee-C4" data-score="0" style="text-align:center;">0</td>
          <td class="score-cell" id="score-C4" rowspan="1">—</td>
        </tr>
        <tr style="background-color: #f8f9fa;">
          <td colspan="6" style="text-align: right; font-weight: bold; border: none;">جمع امتیازهای بخش C</td>
          <td class="score-cell" id="total-knee-score" style="font-weight: bold; background-color: #e9f5ff;">—</td>
        </tr>
      </tbody>
    </table>
    
    <div class="score-box" id="kneeScore">امتیاز بار وارده به زانوها/پاها (C): —</div>
    <div class="note">لطفا توجه داشته باشید: اگر بار فیزیکی به زانوها/پاها وارد شود، فعالیت فرعی بایستی با استفاده از روش KIM-MHO نیز ارزیابی شود.</div>
  </div>

  <div class="card">
    <h3>گام سوم: تعیین امتیاز شرایط کاری نامطلوب</h3>
    <table class="conditions-table condition-factors-table">
      <thead>
        <tr>
          <th style="width:60%">تعیین امتیاز شرایط کاری نامطلوب (فقط در صورت مرتبط بودن مشخص کنید)</th>
          <th style="width:20%">A (کمر)</th>
          <th style="width:20%">B (شانه‌ها/بازوها)</th>
          <th style="width:20%">C (زانوها/پاها)</th>
        </tr>
      </thead>
      <tbody>
        <tr class="condition-row" data-row="1">
          <td>
            پیچش و/یا انحراف جانبی تنه قابل تشخیص است
            <div style="margin-top: 8px;">
              <div class="frequency-option selected" data-value="sometimes" data-score-A="1" data-score-B="0" data-score-C="0">گاهی</div>
              <div class="frequency-option" data-value="frequent" data-score-A="2" data-score-B="0" data-score-C="1">مکرراً تا دائماً</div>
            </div>
          </td>
          <td class="score-cell" id="condition-1-A">1</td>
          <td class="score-cell" id="condition-1-B">0</td>
          <td class="score-cell" id="condition-1-C">0</td>
        </tr>
        <tr class="condition-row" data-row="2">
          <td>سر: به عقب خم شده و/یا شدیدا به جلو خم شده یا گردن دائماً در حال پیچش</td>
          <td class="score-cell" id="condition-2-A">1</td>
          <td class="score-cell" id="condition-2-B">1</td>
          <td class="score-cell" id="condition-2-C">0</td>
        </tr>
        <tr class="condition-row" data-row="3">
          <td>هنگامی که تنه به جلو خم می‌شود، نمی‌توان آن را با دست‌ها، تکیه دادن یا استفاده از ابزار حمایت کرد.</td>
          <td class="score-cell" id="condition-3-A">2</td>
          <td class="score-cell" id="condition-3-B">0</td>
          <td class="score-cell" id="condition-3-C">0</td>
        </tr>
        <tr class="condition-row" data-row="4">
          <td>فضای محدود برای حرکت</td>
          <td class="score-cell" id="condition-4-A">2</td>
          <td class="score-cell" id="condition-4-B">2</td>
          <td class="score-cell" id="condition-4-C">2</td>
        </tr>
        <tr style="background-color: #f8f9fa;">
          <td colspan="1" style="text-align: right; font-weight: bold; border: none;">مجموع امتیازهای ریسک اضافی مربوط به بخش A / B / C</td>
          <td class="score-cell" id="total-conditions-A" style="font-weight: bold; background-color: #e9f5ff;">—</td>
          <td class="score-cell" id="total-conditions-B" style="font-weight: bold; background-color: #e9f5ff;">—</td>
          <td class="score-cell" id="total-conditions-C" style="font-weight: bold; background-color: #e9f5ff;">—</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="card">
    <h3>گام چهارم: تعیین امتیاز سایر شرایط کاری (فقط در صورت مرتبط بودن مشخص کنید)</h3>
    <table class="conditions-table other-conditions-table">
      <thead>
        <tr>
          <th style="width:60%">تعیین امتیاز سایر شرایط کاری</th>
          <th style="width:13.33%">A</th>
          <th style="width:13.33%">B</th>
          <th style="width:13.33%">C</th>
        </tr>
      </thead>
      <tbody>
        <tr class="condition-row" data-row="1">
          <td>تعادل محدود، کف ناهموار</td>
          <td class="selectable-cell" data-group="other-A1" data-score="1">1</td>
          <td class="selectable-cell" data-group="other-B1" data-score="1">1</td>
          <td class="selectable-cell" data-group="other-C1" data-score="1">1</td>
        </tr>
        <tr class="condition-row" data-row="2">
          <td>رطوبت، سرما، سوز شدید، خیس شدن لباس‌ها ممکن است</td>
          <td class="selectable-cell" data-group="other-A2" data-score="1">1</td>
          <td class="selectable-cell" data-group="other-B2" data-score="1">1</td>
          <td class="selectable-cell" data-group="other-C2" data-score="0">0</td>
        </tr>
        <tr class="condition-row" data-row="3">
          <td>ضربه‌های شدید (لرزش‌ها) منجر به تنش فیزیکی می‌شود</td>
          <td class="selectable-cell" data-group="other-A3" data-score="1">1</td>
          <td class="selectable-cell" data-group="other-B3" data-score="1">1</td>
          <td class="selectable-cell" data-group="other-C3" data-score="0">0</td>
        </tr>
        <tr class="condition-row" data-row="4">
          <td>نیاز به تمرکز ذهنی بسیار بالا (مثلاً تشخیص اشیا)</td>
          <td class="selectable-cell" data-group="other-A4" data-score="1">1</td>
          <td class="selectable-cell" data-group="other-B4" data-score="1">1</td>
          <td class="selectable-cell" data-group="other-C4" data-score="0">0</td>
        </tr>
        <tr class="condition-row" data-row="5">
          <td>هیچ کدام: هیچ شرایط کاری نامطلوبی وجود ندارد</td>
          <td class="selectable-cell" data-group="other-A5" data-score="0">0</td>
          <td class="selectable-cell" data-group="other-B5" data-score="0">0</td>
          <td class="selectable-cell" data-group="other-C5" data-score="0">0</td>
        </tr>
        <tr style="background-color: #f8f9fa;">
          <td colspan="1" style="text-align: right; font-weight: bold; border: none;">مجموع امتیازهای ریسک برای شرایط کاری ویژه برای بخش A / B / C</td>
          <td class="score-cell" id="total-other-A" style="font-weight: bold; background-color: #e9f5ff;">—</td>
          <td class="score-cell" id="total-other-B" style="font-weight: bold; background-color: #e9f5ff;">—</td>
          <td class="score-cell" id="total-other-C" style="font-weight: bold; background-color: #e9f5ff;">—</td>
        </tr>
      </tbody>
    </table>
    
    <div class="note">
      لطفا توجه داشته باشید: اگر بارهای فیزیکی ناشی از ارتعاش وجود داشته باشد، باید به طور جداگانه ارزیابی شوند! رجوع کنید به:
      <a href="www.baua.de/vibration" target="_blank">
        www.baua.de/vibration
      </a>
    </div>
  </div>

  <div class="card" id="step8">
    <h3>گام پنجم: محاسبه امتیاز سطح ریسک و اقدام اصلاحی</h3>
    
    <table class="new-calculation-table">
      <thead>
        <tr>
          <th style="width:40%"></th>
          <th style="width:20%">C</th>
          <th style="width:20%">B</th>
          <th style="width:20%">A</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="label-cell">مجموع امتیازهای ریسک در شاخص‌های کلیدی (گام ۲)</td>
          <td id="calc-posture-C">—</td>
          <td id="calc-posture-B">—</td>
          <td id="calc-posture-A">—</td>
        </tr>
        <tr>
          <td class="label-cell">شرایط کاری نامطلوب (گام ۳) +</td>
          <td id="calc-conditions-C">—</td>
          <td id="calc-conditions-B">—</td>
          <td id="calc-conditions-A">—</td>
        </tr>
        <tr>
          <td class="label-cell">سایر شرایط کاری نامطلوب (گام ۴) +</td>
          <td id="calc-other-C">—</td>
          <td id="calc-other-B">—</td>
          <td id="calc-other-A">—</td>
        </tr>
        <tr>
          <td class="label-cell total-cell">مجموع امتیازهای شاخص ها</td>
          <td id="calc-total-C" class="total-cell">—</td>
          <td id="calc-total-B" class="total-cell">—</td>
          <td id="calc-total-A" class="total-cell">—</td>
        </tr>
        <tr>
          <td class="label-cell final-cell">امتیاز زمان</td>
          <td id="final-time-merged" class="final-cell" colspan="3" style="text-align: center;">—</td>
        </tr>
        <tr>
          <td class="label-cell final-cell">امتیاز ریسک پوسچر‌های بدنی × امتیاز زمان</td>
          <td id="final-score-C" class="final-cell">—</td>
          <td id="final-score-B" class="final-cell">—</td>
          <td id="final-score-A" class="final-cell">—</td>
        </tr>
      </tbody>
    </table>
    
    <div class="score-box" id="finalRiskScore">
        <div>امتیاز نهایی: —</div>
        <div class="note" style="color:var(--text-color); margin-top:5px;">(بیش‌ترین امتیاز ریسک محاسبه شده)</div>
    </div>
  </div>

  <div class="card" id="step9">
    <h3>گام نهایی: جدول سطح ریسک و اقدامات اصلاحی</h3>
    <table id="riskTable">
      <thead>
        <tr>
          <th>ریسک</th>
          <th>سطح ریسک</th>
          <th>شدت بار</th>
          <th>الف) احتمال اضافه بار فیزیکی<br>ب) پیامدهای احتمالی برای سلامتی</th>
          <th>اقدامات</th>
        </tr>
      </thead>
      <tbody>
        <tr data-min="0" data-max="19.99" data-risk="1">
          <td>1</td>
          <td>کمتر از 20</td>
          <td>پایین</td>
          <td>الف) احتمال اضافه بار فیزیکی کم است.<br>ب) هیچ خطری برای سلامتی پیش‌بینی نمی‌شود.</td>
          <td>نیازی نیست.</td>
        </tr>
        <tr data-min="20" data-max="49.99" data-risk="2">
          <td>2</td>
          <td>بین 20 تا کمتر از 50</td>
          <td>کمی افزایش یافته</td>
          <td>الف) احتمال اضافه بار فیزیکی برای افراد کم‌تحمل وجود دارد.<br>ب) خستگی و اختلال سازگاری با شدت کم که در زمان فراغت جبران می‌شود.</td>
          <td>برای افراد کم تحمل، بازطراحی محل کار و سایر اقدامات پیشگیرانه ممکن است مفید باشد.</td>
        </tr>
        <tr data-min="50" data-max="99.99" data-risk="3">
          <td>3</td>
          <td>بین 50 تا کمتر از 100</td>
          <td>به‌طور چشمگیری افزایش یافته</td>
          <td>الف) اضافه بار فیزیکی حتی برای افراد با تحمل متوسط نیز ممکن است رخ دهد.<br>ب) اختلالات (معمولاً همراه با درد) که ممکن است شامل اختلال عملکرد اندام‌ها باشد، در اکثر موارد موقتی هستند.</td>
          <td>بازطراحی و اقدامات پیشگیرانه باید مورد بررسی قرار گیرند.</td>
        </tr>
        <tr data-min="100" data-max="999999" data-risk="4">
          <td>4</td>
          <td>برابر یا بیشتر از 100</td>
          <td>بالا</td>
          <td>الف) احتمال اضافه بار فیزیکی بالاست.<br>ب) آسیب‌های ساختاری قابل توجه با عواقب بیماری‌زا و اختلال عملکردی شدید.</td>
          <td>بازطراحی الزامی است و سایر اقدامات پیشگیرانه نیز باید مدنظر قرار گیرند.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="print-section">
    <button class="print-btn" onclick="printFinalResults()">
      🖨️ چاپ نتایج نهایی
    </button>
  </div>

  <script>
    // ---------------------- 1. Shamsi Date Logic ----------------------
    
function toEnglishDigits(str) {
  if (typeof str !== 'string') str = String(str || '');
  return str
    .replace(/[۰-۹]/g, function(d){ return String(d.charCodeAt(0) - 1776); })
    .replace(/[٠-٩]/g, function(d){ return String(d.charCodeAt(0) - 1632); });
}

    const SHAMSI_MONTHS = ["فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور", "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"];
    const CURRENT_SHAMSI_YEAR = (function(){
      try {
        const yFa = new Intl.DateTimeFormat('fa-IR-u-ca-persian', { year: 'numeric' }).format(new Date());
        return parseInt(toEnglishDigits(yFa), 10);
      } catch (e) {
        // Fallback: rough conversion from Gregorian to Jalali year start around Mar 21
        const g = new Date();
        const gy = g.getFullYear();
        const gm = g.getMonth(); // 0-based
        const gd = g.getDate();
        const approx = gy - 621 + ((gm > 2) || (gm == 2 && gd >= 21) ? 1 : 0);
        return approx;
      }
    })();

    function populateShamsiDate() {
      const yearSelect = document.getElementById('year');
      const monthSelect = document.getElementById('month');
      const daySelect = document.getElementById('day');
      
      for (let y = CURRENT_SHAMSI_YEAR - 3; y <= CURRENT_SHAMSI_YEAR + 3; y++) {
        const option = document.createElement('option');
        option.value = y;
        option.textContent = y;
        yearSelect.appendChild(option);
      }
      
      SHAMSI_MONTHS.forEach((name, index) => {
        const option = document.createElement('option');
        option.value = index + 1;
        option.textContent = name;
        monthSelect.appendChild(option);
      });
      
      for (let d = 1; d <= 31; d++) {
        const option = document.createElement('option');
        option.value = d;
        option.textContent = d;
        daySelect.appendChild(option);
      }
    }

    // ---------------------- 2. Time Score Interpolation ----------------------
    function interpolateTimeScore(hours) {
        if (hours <= 0) return 0;
        if (hours <= 1) return 1;
        if (hours >= 10) return 10;
        
        const lowerBound = Math.floor(hours);
        const upperBound = Math.ceil(hours);
        const lowerScore = Math.min(lowerBound, 10);
        const upperScore = Math.min(upperBound, 10);
        
        if (lowerBound === upperBound) return lowerScore;
        
        const ratio = (hours - lowerBound) / (upperBound - lowerBound);
        return lowerScore + ratio * (upperScore - lowerScore);
    }

    // ---------------------- 3. General Cell Selection Handler (FIXED) ----------------------
    function handleCellSelection(event) {
        const targetCell = event.currentTarget;
        const group = targetCell.dataset.group;
        if (!group) return;
        
        const groupParts = group.split('-'); // e.g., ['back', 'A1']
        const sectionInitial = groupParts[1]?.charAt(0); // 'A', 'B', or 'C'

        // 1. Core Selection/Deselection Logic (Single selection per group - i.e., per row)
        const isCurrentlySelected = targetCell.classList.contains('selected');
        
        // Deselect all cells in this group (row) first
        document.querySelectorAll(`.selectable-cell[data-group="${group}"]`).forEach(cell => {
            cell.classList.remove('selected');
        });
        
        // If the cell was not previously selected, select it now. (This handles the toggle and single-select in one go)
        if (!isCurrentlySelected) {
            targetCell.classList.add('selected');
        }

        // 2. Handle Mutual Exclusion for B/C (rows 1-3 vs row 4 - the 'No Load' option) - MUST RUN AFTER SELECTION
        if (sectionInitial === 'B' || sectionInitial === 'C') {
             const rowNum = group.charAt(group.length - 1);
             const baseGroupPrefix = group.match(/^[a-z]+-[A-C]/)[0]; // e.g., 'shoulder-B' from 'shoulder-B1'
             
             // Check if B4/C4 is now selected or deselected
             const isRow4Selected = document.querySelector(`.selectable-cell.selected[data-group="${baseGroupPrefix}4"]`);
             
             if (rowNum === '4') { 
                if (isRow4Selected) {
                    // If B4/C4 is selected, deselect ALL other rows (1-3)
                    for (let i = 1; i <= 3; i++) {
                        document.querySelectorAll(`.selectable-cell[data-group="${baseGroupPrefix}${i}"]`).forEach(cell => {
                            cell.classList.remove('selected');
                        });
                    }
                }
            } else {
                // If any other row (1-3) is selected, deselect B4/C4
                document.querySelectorAll(`.selectable-cell[data-group="${baseGroupPrefix}4"]`).forEach(cell => {
                    cell.classList.remove('selected');
                });
            }
        }
        
        // 3. Score Update Logic: Update all affected rows in the section A, B, or C
        if (['A', 'B', 'C'].includes(sectionInitial)) {
            let maxRow = (sectionInitial === 'A') ? 5 : 4;
            
            // This reliably extracts the common prefix for the group, e.g., 'back-A' from 'back-A1'
            const baseGroup = group.match(/^[a-z]+-[A-C]/)[0];
            
             for (let i = 1; i <= maxRow; i++) {
                // Now group name is correctly constructed: 'back-A' + '1', 'back-A' + '2', etc.
                // This will correctly clear or set the score based on the 'selected' class status
                updateRowScore(`${baseGroup}${i}`, i.toString());
            }
        } else if (group === 'time1') {
             // Handle time selection explicitly
             calculateScores();
             return;
        }

        // 4. Final Calculation (This will trigger updateTotalScores which sums up the 'امتیازها' column)
        calculateScores();
    }


    // ---------------------- 4. Posture 5 Type Management ----------------------
    function setupPosture5TypeManagement() {
        const impossibleRadio = document.getElementById('posture5-impossible');
        const possibleRadio = document.getElementById('posture5-possible');
        const durationCells = document.querySelectorAll('.posture5-duration');
        
        function updatePosture5Scores() {
            const isPossible = possibleRadio.checked;
            let rowWasSelected = false; // flag to force score update if A5 was active
            
            durationCells.forEach(cell => {
                const impossibleScore = cell.dataset.scoreImpossible;
                const possibleScore = cell.dataset.scorePossible;
                
                if (cell.classList.contains('selected')) {
                    rowWasSelected = true;
                }
                
                // Update the visible score and the data-score attribute
                const newScore = isPossible ? possibleScore : impossibleScore;
                cell.textContent = newScore;
                cell.dataset.score = newScore;
            });
            
            if (rowWasSelected) {
                 // **برای تضمین به‌روزرسانی امتیاز A5 پس از تغییر رادیو باتن**
                updateRowScore('back-A5', '5'); 
            }
            
            calculateScores();
        }
        
        impossibleRadio.addEventListener('change', updatePosture5Scores);
        possibleRadio.addEventListener('change', updatePosture5Scores);
        
        // حالت اولیه
        updatePosture5Scores();
    }

    // ---------------------- 5. Update Row Score ----------------------
    function updateRowScore(group, row) {
        // این تابع مسئول قرار دادن امتیاز انتخاب شده در ستون آخر (امتیازها) است.
        const sectionInitial = group.split('-')[1]?.charAt(0); // A, B, or C
        let scoreElement = document.getElementById(`score-${sectionInitial}${row}`);

        // با استفاده از data-group سلول انتخاب شده در آن ردیف را پیدا می‌کند.
        const selectedCell = document.querySelector(`.selectable-cell.selected[data-group="${group}"]`);
        
        if (scoreElement) {
             if (selectedCell) {
                // اگر سلولی در این ردیف انتخاب شده، امتیاز آن را نمایش بده 
                const score = parseFloat(selectedCell.dataset.score);
                // نمایش عدد صحیح یا اعشار تا یک رقم
                scoreElement.textContent = score.toFixed(1).replace('.0', ''); 
            } else {
                // در غیر این صورت، امتیاز را پاک کن (برای deselect)
                scoreElement.textContent = '—';
            }
        }
    }

    // ---------------------- 6. Update Total Scores (SIMPLIFIED FOR ROBUSTNESS) ----------------------
    function updateTotalScores() {
        // تابع بازبینی شده برای اطمینان از جمع صحیح محتوای ستون "امتیازها"

        // محاسبه جمع بخش A
        let backTotal = 0;
        for (let i = 1; i <= 5; i++) {
            const scoreText = document.getElementById(`score-A${i}`)?.textContent;
            // ایمن‌ترین روش برای جمع: اگر عدد نباشد (مثل '—')، مقدار صفر را برمی‌گرداند.
            const score = parseFloat(scoreText) || 0; 
            backTotal += score;
        }
        document.getElementById('total-back-score').textContent = backTotal.toFixed(1).replace('.0', '');
        document.getElementById('backScore').textContent = `امتیاز بار وارده به کمر (A): ${backTotal.toFixed(1).replace('.0', '')}`;

        // محاسبه جمع بخش B (شانه‌ها)
        let shoulderTotal = 0;
        for (let i = 1; i <= 4; i++) {
            const scoreText = document.getElementById(`score-B${i}`)?.textContent;
            const score = parseFloat(scoreText) || 0;
            shoulderTotal += score;
        }
        document.getElementById('total-shoulder-score').textContent = shoulderTotal.toFixed(1).replace('.0', '');
        document.getElementById('shoulderScore').textContent = `امتیاز بار وارده به شانه‌ها و بازوها (B): ${shoulderTotal.toFixed(1).replace('.0', '')}`;

        // محاسبه جمع بخش C (زانوها)
        let kneeTotal = 0;
        for (let i = 1; i <= 4; i++) {
            const scoreText = document.getElementById(`score-C${i}`)?.textContent;
            const score = parseFloat(scoreText) || 0;
            kneeTotal += score;
        }
        document.getElementById('total-knee-score').textContent = kneeTotal.toFixed(1).replace('.0', '');
        document.getElementById('kneeScore').textContent = `امتیاز بار وارده به زانوها/پاها (C): ${kneeTotal.toFixed(1).replace('.0', '')}`;

        return { backTotal, shoulderTotal, kneeTotal };
    }

    // ---------------------- 7. Conditions Table Management (Step 3 & 4) ----------------------
    function setupConditionsTable() {
        // مدیریت کلیک روی ردیف‌های شرایط کاری نامطلوب (گام سوم)
        document.querySelectorAll('.condition-factors-table .condition-row').forEach(row => {
            row.addEventListener('click', function() {
                const rowNum = this.dataset.row;
                this.classList.toggle('selected');
                
                // منطق برای ردیف ۱ که دارای آپشن است
                if (rowNum === '1') {
                    const defaultOption = this.querySelector('.frequency-option[data-value="sometimes"]');
                    const options = this.querySelectorAll('.frequency-option');
                    
                    if (this.classList.contains('selected') && !this.querySelector('.frequency-option.selected')) {
                         // اگر ردیف انتخاب شده اما هیچ آپشنی انتخاب نشده، آپشن پیش فرض را انتخاب کن
                         defaultOption.classList.add('selected');
                         document.getElementById('condition-1-A').textContent = defaultOption.dataset.scoreA;
                         document.getElementById('condition-1-B').textContent = defaultOption.dataset.scoreB;
                         document.getElementById('condition-1-C').textContent = defaultOption.dataset.scoreC;
                    } else if (!this.classList.contains('selected')) {
                        // اگر ردیف لغو انتخاب شد، تمام آپشن‌ها را لغو انتخاب کن
                        options.forEach(opt => opt.classList.remove('selected'));
                        document.getElementById('condition-1-A').textContent = '—';
                        document.getElementById('condition-1-B').textContent = '—';
                        document.getElementById('condition-1-C').textContent = '—';
                    }
                }
                 // برای ردیف‌های بدون آپشن، اگر انتخاب شد، امتیاز را بگذار، اگر لغو شد، امتیاز را پاک کن
                 if (rowNum !== '1') {
                    const isActive = this.classList.contains('selected');
                     ['A', 'B', 'C'].forEach(col => {
                        const scoreCell = document.getElementById(`condition-${rowNum}-${col}`);
                        if (scoreCell) {
                            scoreCell.textContent = isActive ? scoreCell.dataset.initialScore : '—';
                        }
                    });
                }
                
                updateConditionsTotals();
                calculateScores();
            });
             // ذخیره امتیاز اولیه برای ردیف‌هایی که آپشن ندارند
            ['A', 'B', 'C'].forEach(col => {
                const scoreCell = document.getElementById(`condition-${row.dataset.row}-${col}`);
                if (scoreCell) {
                    scoreCell.dataset.initialScore = scoreCell.textContent;
                }
            });
        });

        // مدیریت option button برای ردیف 1 (گام سوم)
        document.querySelectorAll('.condition-factors-table .frequency-option').forEach(option => {
            option.addEventListener('click', function(event) {
                event.stopPropagation();
                
                const parentRow = this.closest('.condition-row');
                const options = parentRow.querySelectorAll('.frequency-option');
                
                options.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                
                document.getElementById('condition-1-A').textContent = this.dataset.scoreA;
                document.getElementById('condition-1-B').textContent = this.dataset.scoreB;
                document.getElementById('condition-1-C').textContent = this.dataset.scoreC;
                
                parentRow.classList.add('selected'); // انتخاب ردیف
                
                updateConditionsTotals();
                calculateScores();
            });
        });

        // --- منطق جدید: مدیریت کلیک روی ردیف‌های سایر شرایط کاری (گام چهارم) ---
        document.querySelectorAll('.other-conditions-table .condition-row').forEach(row => {
            row.addEventListener('click', handleOtherConditionsRowClick);
        });
    }

    function updateConditionsTotals() {
        let totalA = 0, totalB = 0, totalC = 0;
        
        // گام سوم
        document.querySelectorAll('.condition-factors-table .condition-row').forEach(row => {
            const rowNum = row.dataset.row;
            // اگر ردیف انتخاب شده یا امتیاز ردیف ۱ تغییر کرده باشد
            if (row.classList.contains('selected') || rowNum === '1') {
                // باید امتیاز را از محتوای سلول بخوانیم، نه از data-score (زیرا در ردیف ۱ تغییر می‌کند)
                const scoreA = parseFloat(document.getElementById(`condition-${rowNum}-A`).textContent) || 0;
                const scoreB = parseFloat(document.getElementById(`condition-${rowNum}-B`).textContent) || 0;
                const scoreC = parseFloat(document.getElementById(`condition-${rowNum}-C`).textContent) || 0;
                
                totalA += scoreA;
                totalB += scoreB;
                totalC += scoreC;
            }
        });
        
        document.getElementById('total-conditions-A').textContent = totalA;
        document.getElementById('total-conditions-B').textContent = totalB;
        document.getElementById('total-conditions-C').textContent = totalC;
        
        return { totalA, totalB, totalC };
    }

    // === منطق جدید: گام 4 (انتخاب ردیفی و منطق "هیچ کدام") ===
    function handleOtherConditionsRowClick(event) {
        const row = event.currentTarget;
        const cells = row.querySelectorAll('.selectable-cell');
        const rowNum = row.dataset.row;
        const isSelected = row.classList.contains('selected');

        // Logic for Row 5 ("None")
        if (rowNum === '5') {
            if (!isSelected) { // If "None" is being selected
                // Deselect all other rows and their cells
                document.querySelectorAll('.other-conditions-table .condition-row').forEach(otherRow => {
                    if (otherRow !== row) {
                        otherRow.classList.remove('selected');
                        otherRow.querySelectorAll('.selectable-cell').forEach(cell => cell.classList.remove('selected'));
                    }
                });
                
                // Select the 'None' row/cells
                row.classList.add('selected');
                cells.forEach(cell => cell.classList.add('selected'));
            } else {
                // If "None" is being deselected (still remove selected from cells)
                row.classList.remove('selected');
                cells.forEach(cell => cell.classList.remove('selected'));
            }
        } else { // Logic for other rows (1-4)
            // Toggle the current row
            row.classList.toggle('selected', !isSelected);
            cells.forEach(cell => cell.classList.toggle('selected', !isSelected));

            // Deselect the "None" row if it was selected
            const noneRow = document.querySelector('.other-conditions-table .condition-row[data-row="5"]');
            if (noneRow && noneRow.classList.contains('selected')) {
                noneRow.classList.remove('selected');
                noneRow.querySelectorAll('.selectable-cell').forEach(cell => cell.classList.remove('selected'));
            }
        }

        updateOtherScores();
        calculateScores();
    }

    function updateOtherScores() {
        let scores = { A: 0, B: 0, C: 0 };
        
        document.querySelectorAll('.other-conditions-table .condition-row').forEach(row => {
            if (row.classList.contains('selected')) {
                const rowNum = row.dataset.row;
                
                // از data-score سلول انتخاب شده استفاده می کند (چون فقط یک سلول در هر ردیف گام 4 وجود دارد)
                const scoreA = parseFloat(document.querySelector(`[data-group="other-A${rowNum}"]`).dataset.score);
                const scoreB = parseFloat(document.querySelector(`[data-group="other-B${rowNum}"]`).dataset.score);
                const scoreC = parseFloat(document.querySelector(`[data-group="other-C${rowNum}"]`).dataset.score);
                
                if (!isNaN(scoreA)) scores.A += scoreA;
                if (!isNaN(scoreB)) scores.B += scoreB;
                if (!isNaN(scoreC)) scores.C += scoreC;
            }
        });
        
        document.getElementById('total-other-A').textContent = scores.A;
        document.getElementById('total-other-B').textContent = scores.B;
        document.getElementById('total-other-C').textContent = scores.C;
        
        return scores;
    }

    // ---------------------- 8. Score Calculation Functions ----------------------
    function calculateScores() {
        // محاسبه امتیاز زمان (گام ۱)
        let timeScore = 0;
        const timeSelected = document.querySelector('.selectable-cell.selected[data-group="time1"]');
        const timeCustom = parseFloat(document.getElementById('timeCustom').value);
        
        if (!isNaN(timeCustom) && timeCustom > 0) {
            timeScore = interpolateTimeScore(timeCustom);
            // اطمینان از پاک شدن انتخاب دستی جدول در صورت وارد کردن مقدار دستی
            document.querySelectorAll('.selectable-cell[data-group="time1"]').forEach(cell => cell.classList.remove('selected'));
        } else if (timeSelected) {
            timeScore = Number(timeSelected.dataset.score);
        }
        
        document.getElementById('timeScore').textContent = `امتیاز زمان: ${timeScore.toFixed(1).replace('.0', '')}`;

        // محاسبه امتیاز بخش A, B و C (گام ۲) - این تابع اکنون با اطمینان از صحت ستون "امتیازها" جمع نهایی را به‌روز می‌کند
        const { backTotal, shoulderTotal, kneeTotal } = updateTotalScores();

        // محاسبه امتیاز شرایط کاری (گام ۳)
        const { totalA: conditionsA, totalB: conditionsB, totalC: conditionsC } = updateConditionsTotals();

        // محاسبه امتیاز سایر شرایط کاری (گام ۴)
        const { A: otherA, B: otherB, C: otherC } = updateOtherScores();

        // محاسبه مجموع امتیازهای شاخص (گام ۵: ردیف ۴ جدول محاسبات)
        const totalA = backTotal + conditionsA + otherA;
        const totalB = shoulderTotal + conditionsB + otherB;
        const totalC = kneeTotal + conditionsC + otherC;

        // محاسبه امتیازهای نهایی (امتیاز ریسک: ردیف ۶ جدول محاسبات)
        // این منطق (جمع امتیاز شاخص ها × امتیاز زمان) به‌صورت صحیح اعمال شده است.
        const finalA = totalA * timeScore;
        const finalB = totalB * timeScore;
        const finalC = totalC * timeScore;

        // به‌روزرسانی جدول محاسبات (گام ۵)
        document.getElementById('calc-posture-A').textContent = backTotal.toFixed(1).replace('.0', '');
        document.getElementById('calc-posture-B').textContent = shoulderTotal.toFixed(1).replace('.0', '');
        document.getElementById('calc-posture-C').textContent = kneeTotal.toFixed(1).replace('.0', '');
        
        document.getElementById('calc-conditions-A').textContent = conditionsA;
        document.getElementById('calc-conditions-B').textContent = conditionsB;
        document.getElementById('calc-conditions-C').textContent = conditionsC;
        
        // اعمال امتیازهای گام 4
        document.getElementById('calc-other-A').textContent = otherA;
        document.getElementById('calc-other-B').textContent = otherB;
        document.getElementById('calc-other-C').textContent = otherC;
        
        document.getElementById('calc-total-A').textContent = totalA.toFixed(1).replace('.0', '');
        document.getElementById('calc-total-B').textContent = totalB.toFixed(1).replace('.0', '');
        document.getElementById('calc-total-C').textContent = totalC.toFixed(1).replace('.0', '');
        
        // به‌روزرسانی خانه مرج شده امتیاز زمان
        document.getElementById('final-time-merged').textContent = timeScore.toFixed(1).replace('.0', '');

        document.getElementById('final-score-A').textContent = finalA.toFixed(2);
        document.getElementById('final-score-B').textContent = finalB.toFixed(2);
        document.getElementById('final-score-C').textContent = finalC.toFixed(2);

        // پیدا کردن بیشترین امتیاز ریسک
        const maxRisk = Math.max(finalA, finalB, finalC);
        document.getElementById('finalRiskScore').querySelector('div:first-child').textContent = `امتیاز نهایی: ${maxRisk.toFixed(2)}`;

        highlightRiskRow(maxRisk);
    }

    function highlightRiskRow(finalScore) {
        const rows = document.querySelectorAll('#riskTable tbody tr');
        rows.forEach(row => {
            row.className = '';
            const min = parseFloat(row.dataset.min);
            const max = parseFloat(row.dataset.max);
            const riskLevel = row.dataset.risk;

            if (finalScore >= min && finalScore <= max) {
                if (riskLevel === '1') row.classList.add('risk-low'); 
                else if (riskLevel === '2') row.classList.add('risk-slight'); 
                else if (riskLevel === '3') row.classList.add('risk-high'); 
                else if (riskLevel === '4') row.classList.add('risk-very-high'); 
            }
        });
    }

    // ---------------------- 9. Print Function ----------------------
    function printFinalResults() {
        calculateScores();
        
        const currentDate = new Date().toLocaleDateString('fa-IR');
        const location = document.getElementById('location')?.value || '---';
        const evaluator = document.getElementById('evaluator')?.value || '---';
        
        // 1. Prepare Header
        const headerHTML = `
            <div class="print-header">
              <h2>گزارش نهایی ارزیابی KIM-ABP</h2>
              <div>${'تاریخ: '+currentDate+' | محل: '+location+' | ارزیاب: '+evaluator}</div>
            </div>`;

        // 2. Prepare Step 5 (Calculation Table) - needs to be cleaned for print
        let step8TableHTML = document.getElementById('step8').querySelector('table').outerHTML;
        
        // 3. Prepare Final Score Box
        const finalScoreValue = document.getElementById('finalRiskScore').querySelector('div:first-child').textContent;
        const finalScoreNote = document.getElementById('finalRiskScore').querySelector('.note').textContent;
        const finalScoreHTML = `
            <div class="print-final-score" style="color: #007bff;">
                <div>${finalScoreValue}</div>
                <div class="note" style="color:#6c757d; margin-top:5px;">${finalScoreNote}</div>
            </div>`;

        // 4. Prepare Step 6 (Risk Table)
        const step9HTML = document.getElementById('step9').outerHTML;
        
        const w = window.open('', '_blank');
        w.document.write(`<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
<meta charset="UTF-8">
<title>گزارش نهایی ارزیابی KIM-ABP</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">
<style>
  * {
    -webkit-print-color-adjust: exact !important; 
    print-color-adjust: exact !important;
  }
  body{font-family:Vazirmatn, Tahoma, sans-serif;direction:rtl;margin:5px;line-height:1.4;color:#333; font-size: 12px;}
  .print-header{text-align:center;border-bottom:2px solid #007bff;padding-bottom:5px;margin-bottom:10px;}
  .print-header h2{color:#007bff;margin:0 0 3px 0; font-size: 18px;}
  table{width:100%;border-collapse:collapse;margin:5px 0;page-break-inside:avoid;}
  th,td{border:1px solid #333;padding:4px 6px;text-align:right;vertical-align:top;}
  th{background:#f0f0f0;font-weight:700;}
  .risk-low{background-color:#00cc44 !important;}
  .risk-slight{background-color:#ffff66 !important;}
  .risk-high{background-color:#ff9933 !important;}
  .risk-very-high{background-color:#ff3333 !important;}
  .total { background:#f0f0f0 !important; }
  .final { background:#e9f5ff !important; color:#007bff !important; }
  #riskTable th, #riskTable td { font-size: 11px; }
  h3 { margin-top: 10px; font-size: 14px; padding-bottom: 5px; border-bottom: 1px solid #333; }
  .new-calculation-table .empty-cell { border: none; background: transparent; }
  .new-calculation-table .label-cell { text-align: right; font-weight: bold; background-color: #f8f9fa; }
  .new-calculation-table .total-cell { background-color: #f0f0f0; font-weight: bold; }
  .new-calculation-table .final-cell { background-color: #e9f5ff; color: #007bff; font-weight: bold; }
  .new-calculation-table td[colspan="3"] { text-align: center !important; } /* FIX: Time Score Alignment */
  .print-final-score {
      font-weight: bold;
      font-size: 1.2em;
      margin-top: 10px;
      padding: 15px;
      background-color: #e9f5ff; 
      border: 2px solid #cce5ff;
      border-radius: 8px;
      text-align: center;
      color: #007bff;
      page-break-inside: avoid;
    }
  .note {
      font-size: 0.9em;
      color: #6c757d;
      margin-top: 8px;
      font-style: italic;
    }
</style>
</head>
<body>
  <div class="print-container">
    ${headerHTML}
    <h3>گام پنجم: محاسبه امتیاز سطح ریسک و اقدام اصلاحی</h3>
    ${step8TableHTML}
    ${finalScoreHTML}
    ${step9HTML}
  </div>
  <script>window.onload=function(){
    window.print();
    setTimeout(function(){window.close();},300);
  };<\/script>
</body>
</html>`);
        w.document.close();
    }

    // ---------------------- 10. Reset Function ----------------------
    function resetForm() {
        document.querySelectorAll('input[type=text],input[type=number]').forEach(el => el.value = '');
        document.querySelectorAll('select').forEach(el => el.selectedIndex = 0);
        document.querySelectorAll('.selectable-cell').forEach(cell => cell.classList.remove('selected'));
        document.getElementById('timeScore').textContent = 'امتیاز زمان: —';
        document.getElementById('finalRiskScore').querySelector('div:first-child').textContent = 'امتیاز نهایی: —';
        
        // Reset Posture scores and totals
        document.querySelectorAll('.score-cell').forEach(el => el.textContent = '—');
        
        // Reset conditions (Gams 3)
        document.querySelectorAll('.condition-factors-table .condition-row').forEach(row => row.classList.remove('selected'));
        document.querySelectorAll('.conditions-table .frequency-option').forEach(option => option.classList.remove('selected'));
        document.querySelector('#condition-1-A').textContent = '1';
        document.querySelector('#condition-1-B').textContent = '0';
        document.querySelector('#condition-1-C').textContent = '0';
        document.querySelector('.condition-factors-table .frequency-option[data-value="sometimes"]').classList.add('selected');
        ['2', '3', '4'].forEach(rowNum => {
            ['A', 'B', 'C'].forEach(col => {
                const scoreCell = document.getElementById(`condition-${rowNum}-${col}`);
                if (scoreCell) {
                   scoreCell.textContent = scoreCell.dataset.initialScore || '—'; 
                }
            });
        });
        
        // Reset other conditions (Gams 4)
        document.querySelectorAll('.other-conditions-table .condition-row').forEach(row => row.classList.remove('selected'));
        
        document.querySelectorAll('input[type=radio]').forEach(radio => radio.checked = false);
        document.getElementById('posture5-impossible').checked = true;
        
        ['total-back-score', 'total-shoulder-score', 'total-knee-score', 
         'total-conditions-A', 'total-conditions-B', 'total-conditions-C', 'total-other-A', 'total-other-B', 'total-other-C'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = '—';
        });
        
        // Reset calculation table
        document.querySelectorAll('#step8 .new-calculation-table td').forEach(td => {
            if (td.id.startsWith('calc-') || td.id.startsWith('final-')) {
                 td.textContent = '—';
            }
        });
        document.getElementById('final-time-merged').textContent = '—';
        
        document.querySelectorAll('#riskTable tbody tr').forEach(r => r.className = '');
        
        setupPosture5TypeManagement();
        calculateScores();
    }

    // ---------------------- 11. Initialization ----------------------
    function init() {
        populateShamsiDate();
        
        document.querySelectorAll('.selectable-cell').forEach(cell => {
            cell.addEventListener('click', handleCellSelection);
        });

        document.getElementById('timeCustom').addEventListener('input', calculateScores);

        document.getElementById('resetForm').addEventListener('click', resetForm);

        setupPosture5TypeManagement();
        setupConditionsTable();
        calculateScores();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>